<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新房家具家电购买清单</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 自定义样式 -->
    <style>
        /* 户型图标记悬停效果 */
        .floor-plan-marker:hover {
            background-color: var(--marker-hover-color, #dc2626) !important;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* 标记过渡动画 */
        .floor-plan-marker {
            transition: all 0.2s ease;
        }
    </style>
    
    <!-- 预算分析关闭处理脚本 -->
    <script>
        // 直接在HTML中添加事件处理，确保能够访问到应用的内部状态
        document.addEventListener('DOMContentLoaded', function() {
            // 设置图表关闭处理器
            function setupChartCloseHandlers() {
                const chartView = document.getElementById('chart-view');
                const closeChartBtn = document.getElementById('close-chart-view');
                
                if (chartView && closeChartBtn) {
                    // 移除现有的事件监听器，避免重复绑定
                    const newCloseBtn = closeChartBtn.cloneNode(true);
                    closeChartBtn.parentNode.replaceChild(newCloseBtn, closeChartBtn);
                    
                    // 重新绑定关闭按钮事件
                    newCloseBtn.addEventListener('click', function() {
                        chartView.classList.add('hidden');
                        document.body.style.overflow = ''; // 恢复背景滚动
                    });
                    
                    // 重新绑定模态框点击事件
                    chartView.onclick = function(e) {
                        // 检查是否点击的是背景区域
                        if (e.target === chartView || e.target.classList.contains('bg-black')) {
                            chartView.classList.add('hidden');
                            document.body.style.overflow = ''; // 恢复背景滚动
                        }
                    };
                    
                    // 禁用背景滚动
                    document.body.style.overflow = 'hidden';
                    
                    // 阻止滚轮事件冒泡
                    chartView.addEventListener('wheel', function(e) {
                        e.stopPropagation();
                    }, { passive: false });
                }
            }
            
            // 初始尝试设置一次
            setupChartCloseHandlers();
        });
    </script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6b7280',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#06b6d4',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .badge {
                @apply px-2 py-1 text-xs font-semibold rounded-full text-white;
            }
            .btn {
                @apply px-4 py-2 rounded-md font-medium transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-blue-700 focus:ring-blue-500;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-gray-700 focus:ring-gray-500;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-green-700 focus:ring-green-500;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-red-700 focus:ring-red-500;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-yellow-700 focus:ring-yellow-500;
            }
            .btn-info {
                @apply bg-info text-white hover:bg-cyan-700 focus:ring-cyan-500;
            }
            .btn-sm {
                @apply px-3 py-1 text-sm;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .card {
                @apply bg-white rounded-lg shadow-md overflow-hidden;
            }
            .card-header {
                @apply p-4 border-b border-gray-200 bg-gray-50;
            }
            .card-body {
                @apply p-4;
            }
            .nav-link {
                @apply block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md transition-all-300;
            }
            .nav-link.active {
                @apply bg-primary text-white hover:bg-blue-700;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">新房家具家电购买清单</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="add-category-btn" class="btn btn-sm btn-primary flex items-center space-x-1">
                        <i class="fa fa-plus"></i>
                        <span>添加分类</span>
                    </button>
                    <button id="add-item-btn" class="btn btn-sm btn-success flex items-center space-x-1">
                        <i class="fa fa-plus"></i>
                        <span>添加商品</span>
                    </button>
                    <button id="floor-plan-btn" class="btn btn-sm btn-info flex items-center space-x-1">
                        <i class="fa fa-home"></i>
                        <span>户型规划</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- 左侧边栏 -->
            <div class="lg:col-span-1">
                <!-- 分类导航 -->
                <div class="card mb-6">
                    <div class="card-header flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">分类</h2>
                        <div class="text-sm text-gray-500">
                            <span id="total-categories">0</span> 个分类
                        </div>
                    </div>
                    <div class="card-body">
                        <ul id="categories-list" class="space-y-1">
                            <!-- 分类列表将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>

                <!-- 标签筛选 -->
                <div class="card mb-6">
                    <div class="card-header flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">标签</h2>
                        <button id="add-tag-btn" class="text-primary hover:text-blue-700">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="tags-list" class="flex flex-wrap gap-2">
                            <!-- 标签列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-gray-800">预算统计</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">总预算</span>
                                <span class="text-sm font-semibold text-gray-900" id="total-budget">¥0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full" id="total-budget-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">已花费</span>
                                <span class="text-sm font-semibold text-gray-900" id="total-spent">¥0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-success h-2.5 rounded-full" id="total-spent-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">剩余预算</span>
                                <span class="text-sm font-semibold text-gray-900" id="total-remaining">¥0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-warning h-2.5 rounded-full" id="total-remaining-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="pt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">商品总数</span>
                                <span class="text-sm font-semibold text-gray-900" id="total-items">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧主内容 -->
            <div class="lg:col-span-3">
                <!-- 工具栏 -->
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="search-input" class="input-field pl-10" placeholder="搜索商品...">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa fa-search text-gray-400"></i>
                            </div>
                        </div>
                        <select id="sort-select" class="input-field">
                            <option value="name-asc">名称 (A-Z)</option>
                            <option value="name-desc">名称 (Z-A)</option>
                            <option value="budget-asc">预算 (低-高)</option>
                            <option value="budget-desc">预算 (高-低)</option>
                            <option value="price-asc">价格 (低-高)</option>
                            <option value="price-desc">价格 (高-低)</option>
                            <option value="created-asc">创建时间 (早-晚)</option>
                            <option value="created-desc">创建时间 (晚-早)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="budget-analysis-btn" class="btn btn-sm btn-info flex items-center space-x-1">
                            <i class="fa fa-line-chart"></i>
                            <span>预算分析</span>
                        </button>
                        <div class="relative">
                            <button id="import-export-btn" class="btn btn-sm btn-secondary flex items-center space-x-1">
                                <i class="fa fa-download"></i>
                                <span>导入/导出</span>
                            </button>
                            <div id="import-export-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden z-10">
                                <div class="py-1">
                                    <button id="export-data-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fa fa-download mr-2"></i> 导出数据
                                    </button>
                                    <button id="import-data-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fa fa-upload mr-2"></i> 导入数据
                                    </button>
                                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表视图模态框 -->
                <div id="chart-view" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-auto mx-4">
                        <div class="card-header flex justify-between items-center p-4 border-b">
                            <h2 class="text-lg font-semibold text-gray-800">预算分布</h2>
                            <div class="flex items-center space-x-2">
                                <button id="chart-type-pie" class="btn btn-sm btn-primary">饼图</button>
                                <button id="chart-type-bar" class="btn btn-sm btn-secondary">柱状图</button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="w-full h-64 md:h-80">
                                <canvas id="budget-chart"></canvas>
                            </div>
                            <!-- 居中的关闭按钮 -->
                            <div class="mt-4 text-center">
                                <button id="close-chart-view" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                                    <i class="fa fa-times mr-2"></i> 关闭预算分析
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 商品列表 -->
                <div id="items-view">
                    <div id="items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 商品列表将通过JS动态生成 -->
                    </div>
                    <div id="no-items-message" class="text-center py-12 hidden">
                        <div class="text-gray-400 text-5xl mb-4">
                            <i class="fa fa-shopping-cart"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">暂无商品</h3>
                        <p class="text-gray-500 mb-4">点击"添加商品"按钮开始规划您的购买清单</p>
                        <button id="add-first-item-btn" class="btn btn-primary">
                            <i class="fa fa-plus mr-2"></i> 添加第一个商品
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 添加分类模态框 -->
    <div id="add-category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">添加分类</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-category-form" class="space-y-4">
                <div>
                    <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">分类名称</label>
                    <input type="text" id="category-name" class="input-field" required>
                </div>
                <div>
                    <label for="category-budget" class="block text-sm font-medium text-gray-700 mb-1">预算金额</label>
                    <input type="number" id="category-budget" class="input-field" min="0" step="0.01" required>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 添加商品模态框 -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">添加商品</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-item-form" class="space-y-4">
                <div>
                    <label for="add-item-category" class="block text-sm font-medium text-gray-700 mb-1">所属分类</label>
                    <select id="add-item-category" class="input-field" required>
                        <!-- 分类选项将通过JS动态生成 -->
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div>
                    <label for="add-item-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                    <input type="text" id="add-item-name" class="input-field" required>
                </div>
                <div>
                    <label for="add-item-budget" class="block text-sm font-medium text-gray-700 mb-1">预算金额</label>
                    <input type="number" id="add-item-budget" class="input-field" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="add-item-price" class="block text-sm font-medium text-gray-700 mb-1">实际价格</label>
                    <input type="number" id="add-item-price" class="input-field" min="0" step="0.01">
                </div>
                <div>
                    <label for="add-item-status" class="block text-sm font-medium text-gray-700 mb-1">购买状态</label>
                    <select id="add-item-status" class="input-field">
                        <option value="pending">未购买</option>
                        <option value="purchased">已购买</option>
                        <option value="ordered">已下单</option>
                    </select>
                </div>
                <div>
                    <label for="add-item-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="add-item-notes" class="input-field" rows="2"></textarea>
                </div>
                <div>
                    <label for="add-item-pdd-link" class="block text-sm font-medium text-gray-700 mb-1">商品链接</label>
                    <input type="url" id="add-item-pdd-link" class="input-field" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">商品图片</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center cursor-pointer hover:border-primary transition-all-300" id="add-item-image-preview">
                        <input type="file" id="add-item-image" accept="image/*" class="hidden">
                        <div id="add-item-image-content">
                            <i class="fa fa-cloud-upload text-gray-400 text-2xl"></i>
                            <p class="text-sm text-gray-500 mt-2">点击上传商品图片</p>
                            <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                    <div id="add-item-tags" class="flex flex-wrap gap-2">
                        <!-- 标签选择将通过JS动态生成 -->
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <input type="text" id="add-item-new-tag" class="input-field" placeholder="添加新标签...">
                        <button id="add-new-tag-btn" class="btn btn-sm btn-info">添加</button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 编辑商品模态框 -->
    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">编辑商品</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="edit-item-form" class="space-y-4">
                <input type="hidden" id="edit-item-id">
                <div>
                    <label for="edit-item-category" class="block text-sm font-medium text-gray-700 mb-1">所属分类</label>
                    <select id="edit-item-category" class="input-field" required>
                        <!-- 分类选项将通过JS动态生成 -->
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div>
                    <label for="edit-item-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                    <input type="text" id="edit-item-name" class="input-field" required>
                </div>
                <div>
                    <label for="edit-item-budget" class="block text-sm font-medium text-gray-700 mb-1">预算金额</label>
                    <input type="number" id="edit-item-budget" class="input-field" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="edit-item-price" class="block text-sm font-medium text-gray-700 mb-1">实际价格</label>
                    <input type="number" id="edit-item-price" class="input-field" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-item-status" class="block text-sm font-medium text-gray-700 mb-1">购买状态</label>
                    <select id="edit-item-status" class="input-field">
                        <option value="pending">未购买</option>
                        <option value="purchased">已购买</option>
                        <option value="ordered">已下单</option>
                    </select>
                </div>
                <div>
                    <label for="edit-item-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="edit-item-notes" class="input-field" rows="2"></textarea>
                </div>
                <div>
                    <label for="edit-item-pdd-link" class="block text-sm font-medium text-gray-700 mb-1">商品链接</label>
                    <input type="url" id="edit-item-pdd-link" class="input-field" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">商品图片</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center cursor-pointer hover:border-primary transition-all-300" id="edit-item-image-preview">
                        <input type="file" id="edit-item-image" accept="image/*" class="hidden">
                        <div id="edit-item-image-content">
                            <i class="fa fa-cloud-upload text-gray-400 text-2xl"></i>
                            <p class="text-sm text-gray-500 mt-2">点击上传商品图片</p>
                            <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" id="remove-image-btn" class="text-sm text-red-600 hover:text-red-800 hidden">
                            <i class="fa fa-trash mr-1"></i>删除图片
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                    <div id="edit-item-tags" class="flex flex-wrap gap-2">
                        <!-- 标签选择将通过JS动态生成 -->
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <input type="text" id="edit-item-new-tag" class="input-field" placeholder="添加新标签...">
                        <button id="edit-add-new-tag-btn" class="btn btn-sm btn-info">添加</button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 添加标签模态框 -->
    <div id="add-tag-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">添加标签</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-tag-form" class="space-y-4">
                <div>
                    <label for="tag-name" class="block text-sm font-medium text-gray-700 mb-1">标签名称</label>
                    <input type="text" id="tag-name" class="input-field" required>
                </div>
                <div>
                    <label for="tag-color" class="block text-sm font-medium text-gray-700 mb-1">标签颜色</label>
                    <input type="color" id="tag-color" class="input-field" value="#3b82f6">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fa fa-lightbulb-o text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-blue-800">智能预算建议</h4>
                            <p class="text-sm text-blue-700">
                                根据您已添加的商品，我们为您提供以下预算分配建议：
                            </p>
                        </div>
                    </div>
                </div>
                <div id="budget-analysis-content" class="space-y-4">
                    <!-- 预算分析内容将通过JS动态生成 -->
                </div>
                <div class="flex justify-end">
                    <button class="btn btn-primary close-modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h4 class="font-medium text-gray-800 mb-3">选择要标记的商品</h4>
                    <div id="floor-plan-items" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-40 overflow-y-auto">
                        <!-- 商品列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <!-- 预算分析模态框 -->
    <div id="budget-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">预算分析</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 图表容器 -->
                <div class="bg-white rounded-lg p-4">
                    <canvas id="budget-chart" width="400" height="300"></canvas>
                </div>
                
                <!-- 图表说明 -->
                <div class="text-center text-sm text-gray-600">
                    图表显示各分类的预算分布情况
                </div>
                
                <!-- 关闭按钮 -->
                <div class="text-center">
                    <button id="close-budget-analysis" class="btn btn-gray-600 hover:btn-gray-700 px-6 py-2">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 户型规划窗口 -->
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">户型图规划</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 户型图显示区域 -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 text-center" id="floor-plan-display-area">
                    <div id="floor-plan-preview" class="relative inline-block">
                        <img id="floor-plan-image" src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/045546792c9c47ea95ec42083a9b27ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251231214618EED25B0BF9B5A60864C4&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767793578&x-signature=NgYlbxUV0AM7N0q8VcgKezCeHDw%3D" alt="户型图" class="max-w-full max-h-[60vh] mx-auto">
                        <div id="floor-plan-markers" class="absolute inset-0 pointer-events-none overflow-visible z-50"></div>
                    </div>
                </div>
                
                <!-- 工具栏 -->
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <button id="add-marker-btn" class="btn btn-primary flex items-center space-x-1">
                            <i class="fa fa-map-marker"></i>
                            <span>添加标记</span>
                        </button>
                        <button id="delete-marker-btn" class="btn btn-danger flex items-center space-x-1">
                            <i class="fa fa-trash"></i>
                            <span>删除标记</span>
                        </button>

                    </div>
                    <div class="text-sm text-gray-600">
                        提示：选中下方商品后，点击"添加标记"，在户型图上点击即可添加商品位置
                    </div>
                </div>
                
                <!-- 商品列表 -->
                <div class="bg-white rounded-lg shadow-sm p-4">

    <script>
        // 数据管理
        class BudgetManager {
            constructor() {
                this.categories = JSON.parse(localStorage.getItem('budgetCategories')) || [];
                this.items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                this.tags = JSON.parse(localStorage.getItem('budgetTags')) || [];
                this.floorPlan = JSON.parse(localStorage.getItem('floorPlan')) || {
                    image: null,
                    markers: []
                };
                this.currentCategory = 'all';
                this.currentTag = 'all';
                this.chart = null;
                this.selectedFloorPlanItem = null;
                this.isAddingMarker = false;
                this.isDeletingMarker = false;
                this.isSelectingPosition = false;
                this.selectedPosition = null;
                
                // 初始化预设分类和标签
                this.initializeDefaultCategories();
                this.initializeDefaultTags();
                
                // 初始化事件监听
                this.initEventListeners();
                
                // 渲染界面
                this.renderCategories();
                this.renderTags();
                this.renderItems();
                this.updateStats();
                this.renderChart();
            }
            
            // 初始化预设分类
            initializeDefaultCategories() {
                if (this.categories.length === 0) {
                    const defaultCategories = [
                        { id: this.generateId(), name: '客厅', budget: 15000, createdAt: new Date().toISOString() },
                        { id: this.generateId(), name: '卧室', budget: 12000, createdAt: new Date().toISOString() },
                        { id: this.generateId(), name: '厨房', budget: 10000, createdAt: new Date().toISOString() },
                        { id: this.generateId(), name: '卫生间', budget: 8000, createdAt: new Date().toISOString() },
                        { id: this.generateId(), name: '书房', budget: 6000, createdAt: new Date().toISOString() },
                        { id: this.generateId(), name: '其他', budget: 5000, createdAt: new Date().toISOString() }
                    ];
                    
                    this.categories = defaultCategories;
                    this.saveData();
                }
            }
            
            // 初始化预设标签
            initializeDefaultTags() {
                if (this.tags.length === 0) {
                    const defaultTags = [
                        { id: this.generateId(), name: '家具', color: '#3b82f6' },
                        { id: this.generateId(), name: '家电', color: '#10b981' },
                        { id: this.generateId(), name: '装饰品', color: '#f59e0b' },
                        { id: this.generateId(), name: '必需', color: '#ef4444' },
                        { id: this.generateId(), name: '可选', color: '#6b7280' }
                    ];
                    
                    this.tags = defaultTags;
                    this.saveData();
                }
            }
            
            // 初始化事件监听
            initEventListeners() {
                // 添加分类按钮
                document.getElementById('add-category-btn').addEventListener('click', () => {
                    document.getElementById('add-category-modal').classList.remove('hidden');
                });
                
                // 添加分类表单提交
                document.getElementById('add-category-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('category-name').value;
                    const budget = document.getElementById('category-budget').value;
                    
                    if (name && budget) {
                        this.addCategory(name, budget);
                        document.getElementById('add-category-form').reset();
                        document.getElementById('add-category-modal').classList.add('hidden');
                    }
                });
                
                // 添加商品按钮
                document.getElementById('add-item-btn').addEventListener('click', () => {
                    this.showAddItemModal();
                });
                
                // 添加第一个商品按钮
                document.getElementById('add-first-item-btn').addEventListener('click', () => {
                    this.showAddItemModal();
                });
                
                // 添加商品表单提交
                document.getElementById('add-item-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddItemSubmit();
                });
                
                // 编辑商品表单提交
                document.getElementById('edit-item-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleEditItemSubmit();
                });
                
                // 删除商品按钮 - 使用onclick属性直接调用全局函数
                
                // 添加标签按钮
                document.getElementById('add-tag-btn').addEventListener('click', () => {
                    document.getElementById('add-tag-modal').classList.remove('hidden');
                });
                
                // 添加标签表单提交
                document.getElementById('add-tag-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('tag-name').value;
                    const color = document.getElementById('tag-color').value;
                    
                    if (name) {
                        this.addTag(name, color);
                        document.getElementById('add-tag-form').reset();
                        document.getElementById('add-tag-modal').classList.add('hidden');
                    }
                });
                
                // 搜索框
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.currentSearch = e.target.value.toLowerCase();
                    this.renderItems();
                });
                
                // 排序选择
                document.getElementById('sort-select').addEventListener('change', (e) => {
                    this.currentSort = e.target.value;
                    this.renderItems();
                });
                


                
                // 预算分析按钮
                document.getElementById('budget-analysis-btn').addEventListener('click', () => {
                    console.log('预算分析按钮被点击');
                    this.showBudgetAnalysis();
                });
                
                // 导入/导出按钮
                document.getElementById('import-export-btn').addEventListener('click', () => {
                    document.getElementById('import-export-dropdown').classList.toggle('hidden');
                });
                
                // 点击其他地方关闭导入/导出下拉菜单
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('import-export-dropdown');
                    const button = document.getElementById('import-export-btn');
                    
                    if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // 导出数据按钮
                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportData();
                    document.getElementById('import-export-dropdown').classList.add('hidden');
                });
                
                // 导入数据按钮
                document.getElementById('import-data-btn').addEventListener('click', () => {
                    document.getElementById('import-file-input').click();
                    document.getElementById('import-export-dropdown').classList.add('hidden');
                });
                
                // 导入文件输入
                document.getElementById('import-file-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.importData(file);
                    }
                });
                
                // 打开户型图规划窗口的函数
                this.openFloorPlanModal = () => {
                    try {
                        console.log('正在打开户型图规划窗口...');
                        // 重新渲染数据
                        this.renderFloorPlanItems();
                        this.renderFloorPlanMarkers();
                        
                        // 获取模态框元素
                        const floorPlanModal = document.getElementById('floor-plan-modal');
                        
                        if (floorPlanModal) {
                            console.log('找到户型图规划窗口元素');
                            // 清除所有可能阻止显示的样式
                            floorPlanModal.classList.remove('hidden', 'invisible');
                            floorPlanModal.classList.add('flex');
                            
                            // 重置内联样式
                            floorPlanModal.style.cssText = `
                                position: fixed !important;
                                top: 0 !important;
                                left: 0 !important;
                                right: 0 !important;
                                bottom: 0 !important;
                                z-index: 1000 !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                background: rgba(0, 0, 0, 0.5) !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                            `;
                            
                            // 标记为可见状态
                            floorPlanModal.setAttribute('data-visible', 'true');
                            floorPlanModal.setAttribute('aria-hidden', 'false');
                            
                            // 强制显示
                            floorPlanModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            console.log('户型图规划窗口已显示');
                            return true;
                        } else {
                            console.error('户型规划窗口元素未找到');
                            return false;
                        }
                        
                    } catch (error) {
                        console.error('显示户型规划窗口时发生错误:', error);
                        return false;
                    }
                };
                
                // 户型规划按钮 - 增强版本
                document.getElementById('floor-plan-btn').addEventListener('click', () => {
                    this.openFloorPlanModal();
                });
                
                // 添加标记按钮
                document.getElementById('add-marker-btn').addEventListener('click', () => {
                    if (!this.selectedFloorPlanItem) {
                        alert('请先选择一个商品');
                        return;
                    }
                    
                    this.isAddingMarker = true;
                    this.isDeletingMarker = false;
                    document.getElementById('floor-plan-image').style.cursor = 'crosshair';
                    alert('请在户型图上点击选择位置');
                });
                
                // 删除标记按钮
                document.getElementById('delete-marker-btn').addEventListener('click', () => {
                    this.isAddingMarker = false;
                    
                    // 切换删除模式
                    if (this.isDeletingMarker) {
                        // 退出删除模式
                        this.isDeletingMarker = false;
                        document.getElementById('floor-plan-image').style.cursor = 'default';
                    } else {
                        // 进入删除模式
                        this.isDeletingMarker = true;
                        document.getElementById('floor-plan-image').style.cursor = 'pointer';
                        alert('请点击要删除的标记（再次点击删除按钮可退出删除模式）');
                    }
                });
                

                
                // 户型图点击事件
                document.getElementById('floor-plan-image').addEventListener('click', (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    
                    if (this.isAddingMarker && this.selectedFloorPlanItem) {
                        // 添加标记
                        this.addFloorPlanMarker(x, y, this.selectedFloorPlanItem.id);
                        this.isAddingMarker = false;
                        document.getElementById('floor-plan-image').style.cursor = 'default';
                        
                        // 刷新商品卡片显示，更新标记状态
                        this.renderItems();
                        this.renderFloorPlanItems();
                    } else if (this.isDeletingMarker) {
                        // 删除标记
                        const marker = this.getMarkerAtPosition(x, y);
                        if (marker) {
                            this.deleteFloorPlanMarker(marker.id);
                            
                            // 强制立即刷新商品卡片显示，确保标记状态更新
                            setTimeout(() => {
                                this.renderItems();
                                console.log('商品卡片显示已刷新');
                            }, 0);
                            
                            // 刷新户型图标记显示，不需要重新打开窗口
                            this.renderFloorPlanMarkers();
                            
                            // 立即刷新户型图商品列表显示
                            this.renderFloorPlanItems();
                            console.log('户型图商品列表已重新渲染');
                            
                            console.log('标记已删除，所有显示已更新');
                        }
                        // 保持删除模式，让用户可以继续删除其他标记
                        // 不自动退出删除模式
                    } else {
                        // 检查是否点击了标记
                        const marker = this.getMarkerAtPosition(x, y);
                        if (marker) {
                            // 显示商品详情
                            const item = this.items.find(i => i.id === marker.itemId);
                            if (item) {
                                this.showItemDetailModal(item, marker);
                            }
                        }
                    }
                });
                
                // 关闭模态框按钮 - 修复版本
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 获取当前按钮所在的模态框
                        const modal = btn.closest('.fixed.inset-0');
                        
                        if (modal) {
                            // 只关闭当前模态框
                            try {
                                modal.classList.add('hidden');
                                modal.style.display = 'none';
                                modal.style.visibility = 'hidden';
                                modal.setAttribute('data-visible', 'false');
                            } catch (error) {
                                console.error('关闭模态框时发生错误:', error);
                            }
                        } else {
                            // 如果找不到特定模态框，回退到关闭所有模态框
                            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                                if (!modal.id.includes('floor-plan-modal')) {
                                    modal.classList.add('hidden');
                                }
                            });
                        }
                    });
                });
                
                // 商品图片上传预览
                document.getElementById('add-item-image-preview').addEventListener('click', () => {
                    document.getElementById('add-item-image').click();
                });
                
                document.getElementById('add-item-image').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('add-item-image-content');
                            preview.innerHTML = `<img src="${e.target.result}" alt="预览" class="max-w-full max-h-32 mx-auto">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                document.getElementById('edit-item-image-preview').addEventListener('click', () => {
                    document.getElementById('edit-item-image').click();
                });
                
                document.getElementById('edit-item-image').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('edit-item-image-content');
                            preview.innerHTML = `<img src="${e.target.result}" alt="预览" class="max-w-full max-h-32 mx-auto">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // 添加新标签按钮
                document.getElementById('add-new-tag-btn').addEventListener('click', () => {
                    const tagName = document.getElementById('add-item-new-tag').value;
                    if (tagName) {
                        this.addTag(tagName);
                        document.getElementById('add-item-new-tag').value = '';
                        this.renderAddItemTags();
                    }
                });
                
                document.getElementById('edit-add-new-tag-btn').addEventListener('click', () => {
                    const tagName = document.getElementById('edit-item-new-tag').value;
                    if (tagName) {
                        this.addTag(tagName);
                        document.getElementById('edit-item-new-tag').value = '';
                        this.renderEditItemTags();
                    }
                });
            }
            
            // 渲染分类列表
            renderCategories() {
                const categoriesList = document.getElementById('categories-list');
                categoriesList.innerHTML = '';
                
                // 添加"全部"分类
                const allCategoryItem = document.createElement('li');
                allCategoryItem.innerHTML = `
                    <a href="#" class="nav-link ${this.currentCategory === 'all' ? 'active' : ''}" data-category="all">
                        <span class="flex items-center justify-between">
                            <span>全部</span>
                            <span class="bg-gray-200 text-gray-700 text-xs font-medium px-2 py-0.5 rounded-full">${this.items.length}</span>
                        </span>
                    </a>
                `;
                allCategoryItem.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.currentCategory = 'all';
                    this.renderCategories();
                    this.renderItems();
                });
                categoriesList.appendChild(allCategoryItem);
                
                // 添加各个分类
                this.categories.forEach(category => {
                    const categoryItems = this.items.filter(item => item.categoryId === category.id);
                    const categoryBudget = categoryItems.reduce((sum, item) => sum + (item.budget || 0), 0);
                    const categorySpent = categoryItems.reduce((sum, item) => sum + (item.price || 0), 0);
                    
                    const categoryItem = document.createElement('li');
                    categoryItem.innerHTML = `
                        <a href="#" class="nav-link ${this.currentCategory === category.id ? 'active' : ''}" data-category="${category.id}">
                            <div class="flex items-center justify-between mb-1">
                                <span>${category.name}</span>
                                <span class="bg-gray-200 text-gray-700 text-xs font-medium px-2 py-0.5 rounded-full">${categoryItems.length}</span>
                            </div>
                            <div class="text-xs text-gray-500 flex justify-between">
                                <span>预算: ¥${category.budget.toFixed(2)}</span>
                                <span>已用: ¥${categorySpent.toFixed(2)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                <div class="bg-primary h-1.5 rounded-full" style="width: ${Math.min((categoryBudget / category.budget) * 100, 100)}%"></div>
                            </div>
                        </a>
                    `;
                    categoryItem.querySelector('a').addEventListener('click', (e) => {
                        e.preventDefault();
                        this.currentCategory = category.id;
                        this.renderCategories();
                        this.renderItems();
                    });
                    categoriesList.appendChild(categoryItem);
                });
                
                // 更新分类总数
                document.getElementById('total-categories').textContent = this.categories.length;
            }
            
            // 渲染标签列表
            renderTags() {
                const tagsList = document.getElementById('tags-list');
                tagsList.innerHTML = '';
                
                // 添加"全部"标签
                const allTagItem = document.createElement('span');
                allTagItem.innerHTML = `
                    <span class="badge ${this.currentTag === 'all' ? 'bg-primary' : 'bg-gray-300 text-gray-700'}" data-tag="all">全部</span>
                `;
                allTagItem.querySelector('span').addEventListener('click', () => {
                    this.currentTag = 'all';
                    this.renderTags();
                    this.renderItems();
                });
                tagsList.appendChild(allTagItem);
                
                // 添加各个标签
                this.tags.forEach(tag => {
                    const tagItem = document.createElement('span');
                    tagItem.innerHTML = `
                        <span class="badge cursor-pointer" style="background-color: ${this.currentTag === tag.id ? tag.color : '#e5e7eb'}; color: ${this.currentTag === tag.id ? 'white' : '#374151'}" data-tag="${tag.id}">${tag.name}</span>
                    `;
                    tagItem.querySelector('span').addEventListener('click', () => {
                        this.currentTag = tag.id;
                        this.renderTags();
                        this.renderItems();
                    });
                    tagsList.appendChild(tagItem);
                });
            }
            
            // 渲染商品列表
            renderItems() {
                const itemsList = document.getElementById('items-list');
                const noItemsMessage = document.getElementById('no-items-message');
                
                // 过滤商品
                let filteredItems = [...this.items];
                
                // 按分类过滤
                if (this.currentCategory !== 'all') {
                    filteredItems = filteredItems.filter(item => item.categoryId === this.currentCategory);
                }
                
                // 按标签过滤
                if (this.currentTag !== 'all') {
                    filteredItems = filteredItems.filter(item => 
                        item.tags && item.tags.includes(this.currentTag)
                    );
                }
                
                // 按搜索词过滤
                if (this.currentSearch) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(this.currentSearch) ||
                        item.notes && item.notes.toLowerCase().includes(this.currentSearch)
                    );
                }
                
                // 排序商品
                if (this.currentSort) {
                    filteredItems.sort((a, b) => {
                        switch (this.currentSort) {
                            case 'name-asc':
                                return a.name.localeCompare(b.name);
                            case 'name-desc':
                                return b.name.localeCompare(a.name);
                            case 'budget-asc':
                                return (a.budget || 0) - (b.budget || 0);
                            case 'budget-desc':
                                return (b.budget || 0) - (a.budget || 0);
                            case 'price-asc':
                                return (a.price || 0) - (b.price || 0);
                            case 'price-desc':
                                return (b.price || 0) - (a.price || 0);
                            case 'created-asc':
                                return new Date(a.createdAt) - new Date(b.createdAt);
                            case 'created-desc':
                                return new Date(b.createdAt) - new Date(a.createdAt);
                            default:
                                return 0;
                        }
                    });
                }
                
                // 显示或隐藏无商品消息
                if (filteredItems.length === 0) {
                    itemsList.innerHTML = '';
                    noItemsMessage.classList.remove('hidden');
                } else {
                    noItemsMessage.classList.add('hidden');
                    
                    // 渲染商品列表
                    itemsList.innerHTML = '';
                    filteredItems.forEach(item => {
                        const itemCard = document.createElement('div');
                        itemCard.className = 'card hover:shadow-lg transition-all-300';
                        
                        // 获取商品图片或默认图标
                        const itemImage = item.image ? 
                            `<img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover">` : 
                            `<div class="w-full h-40 bg-gray-100 flex items-center justify-center"><i class="fa fa-shopping-bag text-gray-400 text-4xl"></i></div>`;
                        
                        // 获取商品状态标签
                        let statusBadge = '';
                        switch (item.status) {
                            case 'purchased':
                                statusBadge = '<span class="badge bg-success">已购买</span>';
                                break;
                            case 'ordered':
                                statusBadge = '<span class="badge bg-warning">已下单</span>';
                                break;
                            default:
                                statusBadge = '<span class="badge bg-secondary">未购买</span>';
                        }
                        
                        // 获取分类名称
                        const categoryName = this.categories.find(cat => cat.id === item.categoryId)?.name || '未分类';
                        
                        // 检查商品是否在户型图上有标记
                        const hasFloorPlanMarker = this.floorPlan.markers.some(marker => marker.itemId === item.id);
                        console.log('商品卡片渲染 - 主要标记检查:', item.name, 'ID:', item.id, '是否有标记:', hasFloorPlanMarker);
                        
                        // 根据商品分类获取标记颜色
                        const markerColor = hasFloorPlanMarker ? this.getMarkerColorByCategory(categoryName) : '#9ca3af';
                        console.log('商品卡片渲染 - 主要标记颜色:', markerColor, '分类:', categoryName);
                        
                        // 创建标记徽章
                        const markerBadge = `<span class="badge ml-1 marker-badge" data-item-id="${item.id}" style="background-color: ${markerColor}; color: white;" title="${hasFloorPlanMarker ? '已在户型图上标记' : '未在户型图上标记'}"><i class="fa fa-map-marker"></i></span>`;
                        
                        // 获取标签信息
                        const itemTags = item.tags && item.tags.length > 0 ? 
                            `<div class="flex flex-wrap gap-1 mt-2">
                                ${item.tags.map(tagId => {
                                    const tag = this.tags.find(t => t.id === tagId);
                                    return tag ? `<span class="badge" style="background-color: ${tag.color || '#e5e7eb'}">${tag.name}</span>` : '';
                                }).join('')}
                            </div>` : '';
                        
                        // 获取商品链接
                        const itemLink = item.pddLink ? 
                            `<a href="${item.pddLink}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline inline-flex items-center">
                                <i class="fa fa-external-link mr-1"></i>
                                <span>${this.getPlatformName(item.pddLink)}</span>
                            </a>` : '';
                        
                        itemCard.innerHTML = `
                            <div class="relative">
                                ${itemImage}
                                <div class="absolute top-2 right-2 flex items-center">
                                    ${statusBadge}
                                    ${markerBadge}
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-gray-800 mb-2">${item.name}</h3>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600">${categoryName}</span>
                                    <div>
                                        <span class="text-sm font-semibold text-primary">¥${item.budget.toFixed(2)}</span>
                                        ${item.price ? `<span class="text-sm text-gray-500 ml-1">→</span> <span class="text-sm font-semibold text-success">¥${item.price.toFixed(2)}</span>` : ''}
                                    </div>
                                </div>
                                ${itemTags}
                                <div class="mt-2">
                                    ${itemLink || '<span class="text-gray-400 text-sm">暂无商品链接</span>'}
                                </div>
                                <div class="flex space-x-2 mt-4">
                                    <button class="view-item-btn btn btn-sm btn-info flex-1" data-id="${item.id}">
                                        <i class="fa fa-eye mr-1"></i> 详情
                                    </button>
                                    <button class="edit-item-btn btn btn-sm btn-primary flex-1" data-id="${item.id}">
                                        <i class="fa fa-edit mr-1"></i> 编辑
                                    </button>
                                    <button class="delete-item-btn btn btn-sm btn-danger flex-1" data-id="${item.id}">
                                        <i class="fa fa-trash mr-1"></i> 删除
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // 添加查看详情事件
                        itemCard.querySelector('.view-item-btn').addEventListener('click', () => {
                            this.showItemDetails(item);
                        });
                        
                        // 添加编辑事件
                        itemCard.querySelector('.edit-item-btn').addEventListener('click', () => {
                            this.showEditItemModal(item);
                        });
                        
                        // 添加删除事件
                        const deleteBtn = itemCard.querySelector('.delete-item-btn');
                        if (deleteBtn) {
                            console.log('删除按钮找到，绑定事件 - 商品ID:', item.id);
                            deleteBtn.addEventListener('click', (e) => {
                                console.log('删除按钮点击 - 商品ID:', item.id);
                                e.stopPropagation();
                                
                                // 直接执行删除操作，不显示确认对话框
                                console.log('直接执行删除操作');
                                try {
                                    console.log('删除前内存中商品数量:', this.items.length);
                                    
                                    // 从内存中删除商品
                                    const initialLength = this.items.length;
                                    this.items = this.items.filter(i => i.id !== item.id);
                                    console.log('删除后内存中商品数量:', this.items.length);
                                    
                                    if (this.items.length === initialLength) {
                                        alert('未找到要删除的商品');
                                        console.log('未找到要删除的商品');
                                        return;
                                    }
                                    
                                    // 保存更新后的数据到localStorage
                                    localStorage.setItem('budgetItems', JSON.stringify(this.items));
                                    console.log('商品数据已保存到localStorage');
                                    
                                    // 同时删除相关的户型图标记
                                    const floorPlan = JSON.parse(localStorage.getItem('floorPlan')) || { markers: [] };
                                    const updatedMarkers = floorPlan.markers.filter(marker => marker.itemId !== item.id);
                                    if (updatedMarkers.length !== floorPlan.markers.length) {
                                        floorPlan.markers = updatedMarkers;
                                        localStorage.setItem('floorPlan', JSON.stringify(floorPlan));
                                        console.log('户型图标记已更新');
                                        
                                        // 立即更新户型图商品列表显示
                                        this.renderFloorPlanItems();
                                        console.log('户型图商品列表已重新渲染');
                                    }
                                    
                                    // 清空并重新渲染列表
                                    const itemsList = document.getElementById('items-list');
                                    const noItemsMessage = document.getElementById('no-items-message');
                                    
                                    if (itemsList) {
                                        itemsList.innerHTML = '';
                                        console.log('商品列表已清空');
                                    }
                                    
                                    // 重新渲染列表
                                    this.renderItems();
                                    console.log('renderItems方法已调用');
                                    
                                    // 更新统计和图表
                                    this.updateStats();
                                    this.renderChart();
                                    console.log('统计和图表已更新');
                                    
                                    // 显示成功提示
                                    alert('商品删除成功！');
                                } catch (error) {
                                    console.error('Delete error:', error);
                                    alert('删除失败：' + error.message);
                                }
                            });
                        } else {
                            console.error('删除按钮未找到');
                        }
                        
                        itemsList.appendChild(itemCard);
                    });
                }
            }
            
            // 渲染添加商品标签选择
            renderAddItemTags() {
                const tagsContainer = document.getElementById('add-item-tags');
                tagsContainer.innerHTML = '';
                
                this.tags.forEach(tag => {
                    const tagItem = document.createElement('label');
                    tagItem.className = 'inline-flex items-center cursor-pointer';
                    tagItem.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-primary rounded" value="${tag.id}">
                        <span class="ml-2 text-sm text-gray-700">${tag.name}</span>
                    `;
                    tagsContainer.appendChild(tagItem);
                });
            }
            
            // 渲染编辑商品标签选择
            renderEditItemTags(selectedTags = []) {
                const tagsContainer = document.getElementById('edit-item-tags');
                tagsContainer.innerHTML = '';
                
                this.tags.forEach(tag => {
                    const isSelected = selectedTags.some(t => t.id === tag.id);
                    const tagItem = document.createElement('label');
                    tagItem.className = 'inline-flex items-center cursor-pointer';
                    tagItem.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-primary rounded" value="${tag.id}" ${isSelected ? 'checked' : ''}>
                        <span class="ml-2 text-sm text-gray-700">${tag.name}</span>
                    `;
                    tagsContainer.appendChild(tagItem);
                });
            }
            
            // 渲染户型图商品列表
            renderFloorPlanItems() {
                const floorPlanItemsContainer = document.getElementById('floor-plan-items');
                floorPlanItemsContainer.innerHTML = '';
                
                if (this.items.length === 0) {
                    floorPlanItemsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-full py-4">暂无商品，请先添加商品</div>';
                    return;
                }
                
                this.items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'bg-white border rounded-lg p-3 cursor-pointer hover:border-primary transition-all-300';
                    // 检查商品是否在户型图上有标记
                    const hasFloorPlanMarker = this.floorPlan.markers.some(marker => marker.itemId === item.id);
                    console.log('商品卡片渲染 - 次要标记检查:', item.name, 'ID:', item.id, '是否有标记:', hasFloorPlanMarker);
                    
                    // 根据商品分类获取标记颜色
                    const markerColor = hasFloorPlanMarker ? this.getMarkerColorByCategory(item.categoryName || '其他') : '#d1d5db';
                    console.log('商品卡片渲染 - 次要标记颜色:', markerColor);
                    const markerIcon = `<i class="fa fa-map-marker" style="color: ${markerColor};" title="${hasFloorPlanMarker ? '已在户型图上标记' : '未在户型图上标记'}"></i>`;
                    
                    itemCard.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center">
                                <i class="fa fa-shopping-bag text-gray-500"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-1">
                                    <p class="text-sm font-medium text-gray-800 truncate" title="${item.name}">${item.name}</p>
                                    ${markerIcon}
                                </div>
                                <p class="text-xs text-gray-500">${item.categoryName}</p>
                            </div>
                            <div class="text-sm font-semibold text-primary">¥${item.price || item.budget}</div>
                        </div>
                    `;
                    
                    itemCard.addEventListener('click', () => {
                        // 选中商品，进入添加标记模式
                        this.selectedFloorPlanItem = item;
                        document.querySelectorAll('#floor-plan-items > div').forEach(card => {
                            card.classList.remove('border-primary', 'bg-blue-50');
                            card.classList.add('border', 'bg-white');
                        });
                        itemCard.classList.remove('border', 'bg-white');
                        itemCard.classList.add('border-primary', 'bg-blue-50');
                        
                        // 激活添加标记按钮
                        document.getElementById('add-marker-btn').classList.remove('btn-secondary');
                        document.getElementById('add-marker-btn').classList.add('btn-primary');
                    });
                    
                    floorPlanItemsContainer.appendChild(itemCard);
                });
            }
            
            // 渲染户型图标记
            // 根据商品分类获取标记颜色
            getMarkerColorByCategory(categoryName) {
                const colorMap = {
                    '客厅': '#ef4444', // 红色
                    '卧室': '#8b5cf6', // 紫色
                    '厨房': '#10b981', // 绿色
                    '卫生间': '#3b82f6', // 蓝色
                    '餐厅': '#f59e0b', // 橙色
                    '书房': '#6366f1', // 靛蓝色
                    '阳台': '#14b8a6', // 青色
                    '玄关': '#f43f5e', // 玫红色
                    '儿童房': '#84cc16', // 黄绿色
                    '储物间': '#6b7280', // 灰色
                    '其他': '#6b7280'  // 默认灰色
                };
                return colorMap[categoryName] || colorMap['其他'];
            }
            
            // 调整颜色亮度
            adjustColor(color, amount) {
                return '#' + color.replace(/^#/, '').replace(/../g, color => 
                    ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).slice(-2)
                );
            }
            
            renderFloorPlanMarkers() {
                // 清除现有标记
                const existingMarkers = document.querySelectorAll('.floor-plan-marker');
                existingMarkers.forEach(marker => marker.remove());
                
                const markersContainer = document.getElementById('floor-plan-markers');
                if (!markersContainer) return;
                
                this.floorPlan.markers.forEach(marker => {
                    const item = this.items.find(i => i.id === marker.itemId);
                    if (!item) return;
                    
                    const categoryName = this.categories.find(cat => cat.id === item.categoryId)?.name || '其他';
                    
                    // 根据商品分类获取标记颜色
                    const markerColor = this.getMarkerColorByCategory(categoryName);
                    const hoverColor = this.adjustColor(markerColor, -20); // 悬停时颜色稍深
                    
                    const markerElement = document.createElement('div');
                    markerElement.className = 'floor-plan-marker absolute w-6 h-6 text-white rounded-full flex items-center justify-center cursor-pointer shadow-lg transition-all duration-300 z-50 border-1 border-white';
                    markerElement.style.backgroundColor = markerColor;
                    markerElement.style.setProperty('--marker-color', markerColor);
                    markerElement.style.setProperty('--marker-hover-color', hoverColor);
                    markerElement.style.left = `${marker.x}%`;
                    markerElement.style.top = `${marker.y}%`;
                    markerElement.style.transform = 'translate(-50%, -50%)';
                    markerElement.style.pointerEvents = 'auto';
                    markerElement.innerHTML = `<i class="fa fa-map-marker"></i>`;
                    markerElement.title = `${item.name} - ¥${item.price || item.budget}`;
                    markerElement.dataset.itemId = item.id;
                    markerElement.dataset.markerId = marker.id;
                    markerElement.dataset.itemName = item.name;
                    markerElement.dataset.itemPrice = item.price || item.budget;
                    markerElement.dataset.categoryName = categoryName;
                    
                    // 点击标记显示详细信息窗口
                    markerElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        this.showItemDetailModal(item, marker);
                    });
                    
                    // 悬停显示商品信息
                    markerElement.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        this.showMarkerTooltip(markerElement, item);
                    });
                    
                    markerElement.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        this.hideMarkerTooltip();
                    });
                    
                    // 右键删除标记
                    markerElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        if (confirm('确定要删除这个标记吗？')) {
                            this.deleteFloorPlanMarker(marker.id);
                        }
                    });
                    
                    markersContainer.appendChild(markerElement);
                });
            }
            
            // 显示标记提示框
            showMarkerTooltip(markerElement, item) {
                // 移除现有提示框
                this.hideMarkerTooltip();
                
                // 创建提示框
                const tooltip = document.createElement('div');
                tooltip.id = 'marker-tooltip';
                tooltip.className = 'absolute bg-white text-gray-800 p-3 rounded-lg shadow-lg border border-gray-200 z-50 max-w-xs';
                tooltip.style.pointerEvents = 'none';
                tooltip.innerHTML = `
                    <div class="font-medium">${item.name}</div>
                    <div class="text-sm text-gray-600">${item.categoryName}</div>
                    <div class="text-sm font-semibold text-primary">¥${(item.price || item.budget).toFixed(2)}</div>
                    ${item.tags && item.tags.length > 0 ? `
                        <div class="text-xs mt-1">
                            ${item.tags.map(tag => `<span class="inline-block bg-gray-100 text-gray-600 px-2 py-0.5 rounded mr-1">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                `;
                
                // 计算位置，显示在标记的右侧
                const markerRect = markerElement.getBoundingClientRect();
                const containerRect = document.getElementById('floor-plan-markers').getBoundingClientRect();
                
                tooltip.style.left = `${markerRect.left - containerRect.left + markerRect.width + 10}px`;
                tooltip.style.top = `${markerRect.top - containerRect.top}px`;
                
                // 添加到容器
                document.getElementById('floor-plan-markers').appendChild(tooltip);
            }
            
            // 隐藏标记提示框
            hideMarkerTooltip() {
                const tooltip = document.getElementById('marker-tooltip');
                if (tooltip) {
                    tooltip.remove();
                }
            }
            
            // 更新统计信息
            updateStats() {
                const totalBudget = this.items.reduce((sum, item) => sum + (item.budget || 0), 0);
                const totalSpent = this.items.reduce((sum, item) => sum + (item.price || 0), 0);
                const totalRemaining = totalBudget - totalSpent;
                
                document.getElementById('total-budget').textContent = `¥${totalBudget.toFixed(2)}`;
                document.getElementById('total-spent').textContent = `¥${totalSpent.toFixed(2)}`;
                document.getElementById('total-remaining').textContent = `¥${totalRemaining.toFixed(2)}`;
                document.getElementById('total-items').textContent = this.items.length;
                
                // 更新进度条
                const categoryBudget = this.categories.reduce((sum, cat) => sum + cat.budget, 0);
                document.getElementById('total-budget-progress').style.width = `${Math.min((totalBudget / categoryBudget) * 100, 100)}%`;
                document.getElementById('total-spent-progress').style.width = `${totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0}%`;
                document.getElementById('total-remaining-progress').style.width = `${totalBudget > 0 ? (totalRemaining / totalBudget) * 100 : 0}%`;
            }
            
            // 渲染图表
            renderChart() {
                const ctx = document.getElementById('budget-chart').getContext('2d');
                
                // 准备数据
                const categoryData = this.categories.map(category => {
                    const categoryItems = this.items.filter(item => item.categoryId === category.id);
                    const budget = categoryItems.reduce((sum, item) => sum + (item.budget || 0), 0);
                    const spent = categoryItems.reduce((sum, item) => sum + (item.price || 0), 0);
                    
                    return {
                        category: category.name,
                        budget: budget,
                        spent: spent,
                        remaining: budget - spent
                    };
                });
                
                // 销毁现有图表
                if (this.chart) {
                    this.chart.destroy();
                }
                
                // 创建新图表
                if (this.chartType === 'pie') {
                    this.chart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: categoryData.map(d => d.category),
                            datasets: [{
                                label: '预算',
                                data: categoryData.map(d => d.budget),
                                backgroundColor: [
                                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899',
                                    '#6366f1', '#14b8a6', '#f97316', '#e11d48', '#a855f7', '#db2777'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((value / total) * 100);
                                            return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    this.chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: categoryData.map(d => d.category),
                            datasets: [
                                {
                                    label: '已花费',
                                    data: categoryData.map(d => d.spent),
                                    backgroundColor: '#10b981',
                                    borderWidth: 1
                                },
                                {
                                    label: '剩余预算',
                                    data: categoryData.map(d => d.remaining),
                                    backgroundColor: '#f59e0b',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + value;
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }
            
            // 显示添加商品模态框
            showAddItemModal() {
                // 重置表单
                document.getElementById('add-item-form').reset();
                document.getElementById('add-item-image-content').innerHTML = `
                    <i class="fa fa-cloud-upload text-gray-400 text-2xl"></i>
                    <p class="text-sm text-gray-500 mt-2">点击上传商品图片</p>
                    <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
                `;
                
                // 填充分类选项
                const categorySelect = document.getElementById('add-item-category');
                categorySelect.innerHTML = '<option value="">请选择分类</option>';
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // 渲染标签选择
                this.renderAddItemTags();
                
                // 显示模态框
                document.getElementById('add-item-modal').classList.remove('hidden');
            }
            
            // 处理添加商品表单提交
            handleAddItemSubmit() {
                const categoryId = document.getElementById('add-item-category').value;
                const name = document.getElementById('add-item-name').value;
                const budget = document.getElementById('add-item-budget').value;
                const price = document.getElementById('add-item-price').value;
                const status = document.getElementById('add-item-status').value;
                const notes = document.getElementById('add-item-notes').value;
                const pddLink = document.getElementById('add-item-pdd-link').value;
                
                // 获取选中的标签
                const tagCheckboxes = document.querySelectorAll('#add-item-tags input[type="checkbox"]:checked');
                const tagIds = Array.from(tagCheckboxes).map(checkbox => checkbox.value);
                
                // 获取图片
                let imageData = null;
                const imagePreview = document.getElementById('add-item-image-content').querySelector('img');
                if (imagePreview) {
                    imageData = imagePreview.src;
                }
                
                if (categoryId && name && budget) {
                    console.log('添加商品 - 分类ID:', categoryId, '商品名称:', name);
                    const category = this.categories.find(cat => cat.id === categoryId);
                    if (category) {
                        console.log('找到分类:', category.name);
                        const newItem = this.addItem(categoryId, name, budget, price, status, notes, tagIds, pddLink, imageData);
                        console.log('新商品:', newItem);
                        
                        // 如果是从户型图添加的商品，在户型图上添加标记
                        if (window.isAddingItemOnPlan && this.selectedPosition) {
                            this.addFloorPlanMarker(this.selectedPosition.x, this.selectedPosition.y, newItem.id);
                            this.selectedPosition = null;
                            window.isAddingItemOnPlan = false;
                        }
                        
                        document.getElementById('add-item-form').reset();
                        document.getElementById('add-item-modal').classList.add('hidden');
                    }
                }
            }
            
            // 显示编辑商品模态框
            showEditItemModal(item) {
                console.log('显示编辑商品模态框 - 商品ID:', item.id);
                
                try {
                    // 填充表单数据
                    const idInput = document.getElementById('edit-item-id');
                    const categoryInput = document.getElementById('edit-item-category');
                    const nameInput = document.getElementById('edit-item-name');
                    const budgetInput = document.getElementById('edit-item-budget');
                    const priceInput = document.getElementById('edit-item-price');
                    const statusInput = document.getElementById('edit-item-status');
                    const notesInput = document.getElementById('edit-item-notes');
                    const pddLinkInput = document.getElementById('edit-item-pdd-link');
                    
                    if (idInput) idInput.value = item.id;
                    if (categoryInput) categoryInput.value = item.categoryId;
                    if (nameInput) nameInput.value = item.name;
                    if (budgetInput) budgetInput.value = item.budget;
                    if (priceInput) priceInput.value = item.price || '';
                    if (statusInput) statusInput.value = item.status || 'pending';
                    if (notesInput) notesInput.value = item.notes || '';
                    if (pddLinkInput) pddLinkInput.value = item.pddLink || '';
                    
                    // 填充图片预览
                    const imageContent = document.getElementById('edit-item-image-content');
                    const removeButton = document.getElementById('remove-image-btn');
                    
                    if (imageContent) {
                        if (item.image) {
                            console.log('显示现有商品图片');
                            imageContent.innerHTML = `<img src="${item.image}" alt="${item.name}" class="max-w-full max-h-32 mx-auto rounded">`;
                            if (removeButton) {
                                removeButton.classList.remove('hidden');
                            }
                        } else {
                            console.log('显示默认上传提示');
                            imageContent.innerHTML = `
                                <i class="fa fa-cloud-upload text-gray-400 text-2xl"></i>
                                <p class="text-sm text-gray-500 mt-2">点击上传商品图片</p>
                                <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
                            `;
                            if (removeButton) {
                                removeButton.classList.add('hidden');
                            }
                        }
                    }
                    
                    // 绑定图片上传事件
                    this.bindImageUploadEvents(item);
                    
                    // 显示编辑模态框
                    const editModal = document.getElementById('edit-item-modal');
                    if (editModal) {
                        console.log('显示编辑模态框');
                        
                        // 确保模态框在最上层
                        editModal.style.cssText = `
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            right: 0 !important;
                            bottom: 0 !important;
                            z-index: 20000 !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            background: rgba(0, 0, 0, 0.5) !important;
                        `;
                        
                        editModal.classList.remove('hidden');
                        editModal.classList.add('flex');
                        
                        // 强制显示在最上层
                        editModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // 设置焦点到商品名称输入框
                        if (nameInput) {
                            setTimeout(() => {
                                nameInput.focus();
                                nameInput.select();
                            }, 100);
                        }
                        
                        // 添加简单的关闭事件处理
                        const closeModal = () => {
                            console.log('直接关闭编辑模态框');
                            
                            try {
                                // 只隐藏编辑模态框，完全不影响户型规划窗口
                                // 使用更可靠的方式确保只影响当前模态框
                                if (editModal && editModal.style) {
                                    // 保存当前状态
                                    const currentDisplay = editModal.style.display;
                                    console.log('编辑模态框关闭前显示状态:', currentDisplay);
                                    
                                    // 强制隐藏编辑模态框
                                    editModal.style.display = 'none';
                                    editModal.style.visibility = 'hidden';
                                    editModal.setAttribute('data-visible', 'false');
                                    
                                    // 确保户型规划窗口不受影响
                                    const floorPlanModal = document.getElementById('floor-plan-modal');
                                    if (floorPlanModal) {
                                        console.log('户型规划窗口状态保持不变');
                                        // 不主动操作户型规划窗口，让它保持当前状态
                                    }
                                    
                                    console.log('编辑模态框已关闭，户型规划窗口保持不变');
                                }
                            } catch (error) {
                                console.error('关闭编辑模态框时发生错误:', error);
                            }
                        };
                        
                        // 标记编辑模态框为可见
                        editModal.setAttribute('data-visible', 'true');
                        
                        // ESC键关闭
                        const escHandler = (e) => {
                            if (e.key === 'Escape') {
                                e.preventDefault();
                                e.stopPropagation(); // 阻止事件冒泡
                                console.log('ESC键被按下，关闭编辑模态框');
                                closeModal();
                            }
                        };
                        document.addEventListener('keydown', escHandler);
                        
                        // 背景点击关闭
                        editModal.addEventListener('click', (e) => {
                            if (e.target === editModal) {
                                e.stopPropagation(); // 阻止事件冒泡
                                console.log('编辑模态框背景被点击');
                                closeModal();
                            }
                        });
                        
                        // 查找并绑定关闭按钮
                        const closeButtons = editModal.querySelectorAll('.close-modal, .btn-close, .cancel-btn, [data-dismiss="modal"]');
                        closeButtons.forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation(); // 阻止事件冒泡
                                console.log('编辑模态框关闭按钮被点击');
                                closeModal();
                            });
                        });
                        
                        console.log('编辑模态框显示成功，z-index设置为20000');
                    } else {
                        console.error('编辑模态框元素未找到');
                        // 如果没有专门的编辑模态框，尝试使用添加商品的模态框
                        const addModal = document.getElementById('add-item-modal');
                        if (addModal) {
                            console.log('使用添加商品模态框进行编辑');
                            
                            // 确保模态框在最上层
                            addModal.style.cssText = `
                                position: fixed !important;
                                top: 0 !important;
                                left: 0 !important;
                                right: 0 !important;
                                bottom: 0 !important;
                                z-index: 20000 !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                background: rgba(0, 0, 0, 0.5) !important;
                            `;
                            
                            addModal.classList.remove('hidden');
                            addModal.classList.add('flex');
                            
                            // 更新模态框标题
                            const modalTitle = document.querySelector('#add-item-modal .modal-title');
                            if (modalTitle) {
                                modalTitle.textContent = '编辑商品';
                            }
                            
                            // 强制显示在最上层
                            addModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            if (nameInput) {
                                setTimeout(() => {
                                    nameInput.focus();
                                    nameInput.select();
                                }, 100);
                            }
                            
                            // 添加简单的关闭事件处理
                            const closeAddModal = () => {
                                try {
                                    // 只隐藏添加模态框，完全不影响户型规划窗口
                                    // 使用更可靠的方式确保只影响当前模态框
                                    if (addModal && addModal.style) {
                                        // 强制隐藏添加模态框
                                        addModal.style.display = 'none';
                                        addModal.style.visibility = 'hidden';
                                        addModal.setAttribute('data-visible', 'false');
                                        
                                        // 确保户型规划窗口不受影响
                                        const floorPlanModal = document.getElementById('floor-plan-modal');
                                        if (floorPlanModal) {
                                            // 不主动操作户型规划窗口，让它保持当前状态
                                        }
                                    }
                                } catch (error) {
                                    console.error('关闭添加模态框时发生错误:', error);
                                }
                            };
                            
                            // 标记添加模态框为可见
                            addModal.setAttribute('data-visible', 'true');
                            
                            // ESC键关闭
                            const addModalEscHandler = (e) => {
                                if (e.key === 'Escape') {
                                    e.preventDefault();
                                    e.stopPropagation(); // 阻止事件冒泡
                                    closeAddModal();
                                }
                            };
                            document.addEventListener('keydown', addModalEscHandler);
                            
                            // 背景点击关闭
                            addModal.addEventListener('click', (e) => {
                                if (e.target === addModal) {
                                    e.stopPropagation(); // 阻止事件冒泡
                                    console.log('添加模态框背景被点击');
                                    closeAddModal();
                                }
                            });
                            
                            // 查找并绑定关闭按钮
                            const closeButtons = addModal.querySelectorAll('.close-modal, .btn-close, .cancel-btn, [data-dismiss="modal"]');
                            closeButtons.forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation(); // 阻止事件冒泡
                                    console.log('添加模态框关闭按钮被点击');
                                    closeAddModal();
                                });
                            });
                            
                            console.log('添加商品模态框显示成功，z-index设置为20000');
                        } else {
                            console.error('未找到任何商品模态框');
                            this.showSimpleNotification('编辑功能暂不可用，请稍后再试', 'warning');
                        }
                    }
                    
                } catch (error) {
                    console.error('显示编辑模态框时发生错误:', error);
                    this.showSimpleNotification('打开编辑窗口失败', 'error');
                }
            }
            
            // 绑定图片上传相关事件
            bindImageUploadEvents(item) {
                console.log('绑定图片上传相关事件', item);
                
                // 图片预览区域点击事件
                const imagePreview = document.getElementById('edit-item-image-preview');
                const imageInput = document.getElementById('edit-item-image');
                const removeButton = document.getElementById('remove-image-btn');
                
                if (imagePreview && imageInput) {
                    // 移除现有的事件监听器（避免重复绑定）
                    const newImageInput = document.getElementById('edit-item-image');
                    
                    // 绑定点击事件 - 使用更安全的方式
                    const handlePreviewClick = function() {
                        console.log('点击图片预览区域，触发文件选择');
                        newImageInput.click();
                    };
                    
                    // 移除可能存在的旧事件监听器
                    imagePreview.replaceWith(imagePreview.cloneNode(true));
                    const freshPreview = document.getElementById('edit-item-image-preview');
                    
                    // 绑定新的事件监听器
                    freshPreview.addEventListener('click', handlePreviewClick);
                    
                    // 文件输入变化事件
                    const handleFileChange = function(e) {
                        console.log('文件输入变化，检测到新文件');
                        if (e.target.files && e.target.files[0]) {
                            const file = e.target.files[0];
                            console.log('选择的文件:', file.name, file.type, file.size);
                            
                            // 验证文件类型
                            if (!file.type.startsWith('image/')) {
                                alert('请选择图片文件（JPG、PNG等）');
                                newImageInput.value = '';
                                return;
                            }
                            
                            // 验证文件大小（限制为5MB）
                            if (file.size > 5 * 1024 * 1024) {
                                alert('图片文件大小不能超过5MB');
                                newImageInput.value = '';
                                return;
                            }
                            
                            // 使用FileReader读取文件并显示预览（可靠的方式）
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    console.log('文件读取完成，显示预览');
                                    const imageContent = document.getElementById('edit-item-image-content');
                                    imageContent.innerHTML = `<img src="${e.target.result}" alt="预览图片" class="max-w-full max-h-32 mx-auto rounded">`;
                                    
                                    // 显示删除按钮
                                    const removeBtn = document.getElementById('remove-image-btn');
                                    if (removeBtn) {
                                        removeBtn.classList.remove('hidden');
                                    }
                                    
                                    console.log('图片预览显示成功');
                                } catch (displayError) {
                                    console.error('显示预览时出错:', displayError);
                                    this.showToast('图片预览显示失败，请重试', 'error');
                                    newImageInput.value = '';
                                }
                            };
                            reader.onerror = function(error) {
                                console.error('文件读取失败:', error);
                                this.showToast('图片预览失败，请重试', 'error');
                                newImageInput.value = '';
                            };
                            reader.onabort = function() {
                                console.error('文件读取被中止');
                                this.showToast('图片上传被中止', 'error');
                                newImageInput.value = '';
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    
                    // 移除可能存在的旧事件监听器并绑定新的
                    newImageInput.addEventListener('change', handleFileChange);
                }
                
                // 删除图片按钮事件
                if (removeButton) {
                    const handleRemoveClick = function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        console.log('点击删除图片按钮');
                        
                        // 清空图片预览
                        const imageContent = document.getElementById('edit-item-image-content');
                        if (imageContent) {
                            imageContent.innerHTML = `
                                <i class="fa fa-cloud-upload text-gray-400 text-2xl"></i>
                                <p class="text-sm text-gray-500 mt-2">点击上传商品图片</p>
                                <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
                            `;
                        }
                        
                        // 清空文件输入
                        if (imageInput) {
                            imageInput.value = '';
                        }
                        
                        // 隐藏删除按钮
                        this.classList.add('hidden');
                        
                        console.log('图片已删除');
                    };
                    
                    // 移除可能存在的旧事件监听器并绑定新的
                    removeButton.addEventListener('click', handleRemoveClick);
                }
                
                // 填充分类选项
                const categorySelect = document.getElementById('edit-item-category');
                if (categorySelect && item) {
                    categorySelect.innerHTML = '<option value="">请选择分类</option>';
                    this.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        if (category.id === item.categoryId) {
                            option.selected = true;
                        }
                        categorySelect.appendChild(option);
                    });
                    
                    // 渲染标签选择
                    this.renderEditItemTags(item.tags || []);
                }
                
                // 显示模态框
                document.getElementById('edit-item-modal').classList.remove('hidden');
            }
            
            // 处理编辑商品表单提交
            handleEditItemSubmit() {
                const id = document.getElementById('edit-item-id').value;
                const categoryId = document.getElementById('edit-item-category').value;
                const name = document.getElementById('edit-item-name').value;
                const budget = document.getElementById('edit-item-budget').value;
                const price = document.getElementById('edit-item-price').value;
                const status = document.getElementById('edit-item-status').value;
                const notes = document.getElementById('edit-item-notes').value;
                const pddLink = document.getElementById('edit-item-pdd-link').value;
                
                // 获取选中的标签
                const tagCheckboxes = document.querySelectorAll('#edit-item-tags input[type="checkbox"]:checked');
                const tagIds = Array.from(tagCheckboxes).map(checkbox => checkbox.value);
                
                console.log('开始处理编辑商品表单提交');
                console.log('商品ID:', id);
                console.log('选中的标签ID:', tagIds);
                
                // 验证必填字段
                if (!id || !categoryId || !name || !budget) {
                    alert('请填写所有必填字段');
                    return;
                }
                
                // 获取图片 - 优先使用新上传的图片
                const imageInput = document.getElementById('edit-item-image');
                const imagePreview = document.getElementById('edit-item-image-content').querySelector('img');
                
                // 获取当前编辑的商品
                const currentItem = this.items.find(item => item.id === id);
                let imageData = currentItem ? currentItem.image : null; // 默认使用现有图片
                
                console.log('当前商品现有图片:', currentItem ? !!currentItem.image : false);
                
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    // 如果有新上传的文件，使用FileReader读取
                    const file = imageInput.files[0];
                    console.log('检测到新上传的图片文件:', file.name, file.type, file.size);
                    
                    // 验证文件类型
                    if (!file.type.startsWith('image/')) {
                        alert('请选择图片文件（JPG、PNG等）');
                        imageInput.value = '';
                        return;
                    }
                    
                    // 验证文件大小（限制为5MB）
                    if (file.size > 5 * 1024 * 1024) {
                        alert('图片文件大小不能超过5MB');
                        imageInput.value = '';
                        return;
                    }
                    
                    // 使用FileReader读取文件并转换为base64格式（可靠的持久化存储方式）
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            console.log('图片文件读取完成');
                            imageData = e.target.result;
                            console.log('图片数据长度:', imageData.length);
                            
                            // 保存商品
                            this.saveEditedItem(id, categoryId, name, budget, price, status, notes, tagIds, pddLink, imageData);
                        } catch (saveError) {
                            console.error('保存图片数据时出错:', saveError);
                            alert('图片保存失败，请重试');
                        }
                    };
                    reader.onerror = (error) => {
                        console.error('图片文件读取失败:', error);
                        alert('图片上传失败，请重试');
                    };
                    reader.onabort = () => {
                        console.error('图片文件读取被中止');
                        alert('图片上传被中止');
                    };
                    reader.readAsDataURL(file);
                    return; // 等待文件读取完成后再继续
                } else if (imagePreview && imagePreview.src && imagePreview.src !== window.location.href) {
                    // 如果没有新上传的文件，但有预览图且不是默认图片，使用预览图
                    console.log('使用预览图片作为新图片数据');
                    imageData = imagePreview.src;
                    console.log('预览图片数据长度:', imageData.length);
                    
                    // 保存商品
                    this.saveEditedItem(id, categoryId, name, budget, price, status, notes, tagIds, pddLink, imageData);
                } else {
                    console.log('没有检测到新图片，使用现有图片数据');
                    console.log('使用的图片数据:', imageData ? '有数据' : '无数据');
                    
                    // 保存商品
                    this.saveEditedItem(id, categoryId, name, budget, price, status, notes, tagIds, pddLink, imageData);
                }
            }
            
            // 保存编辑后的商品
            saveEditedItem(id, categoryId, name, budget, price, status, notes, tagIds, pddLink, imageData) {
                console.log('开始保存编辑后的商品');
                console.log('商品ID:', id);
                console.log('分类ID:', categoryId);
                console.log('商品名称:', name);
                console.log('预算:', budget);
                console.log('标签ID数组:', tagIds);
                console.log('是否有图片数据:', !!imageData);
                
                try {
                    // 验证参数
                    if (!id || !categoryId || !name || !budget) {
                        console.error('缺少必要的商品信息');
                        alert('保存失败：请填写所有必填字段');
                        return;
                    }
                    
                    // 查找分类
                    const category = this.categories.find(cat => cat.id === categoryId);
                    if (!category) {
                        console.error('未找到指定的分类:', categoryId);
                        alert('保存失败：未找到指定的分类');
                        return;
                    }
                    
                    // 获取标签详情
                    console.log('处理标签数据，标签ID数量:', tagIds.length);
                    const tags = [];
                    for (const tagId of tagIds) {
                        const tag = this.tags.find(t => t.id === tagId);
                        if (tag) {
                            tags.push({ id: tag.id, name: tag.name, color: tag.color });
                        } else {
                            console.warn('未找到标签:', tagId);
                        }
                    }
                    console.log('处理后的标签数量:', tags.length);
                    
                    // 查找要更新的商品
                    const itemIndex = this.items.findIndex(item => item.id === id);
                    if (itemIndex === -1) {
                        console.error('未找到要编辑的商品:', id);
                        alert('保存失败：未找到要编辑的商品');
                        return;
                    }
                    
                    // 准备更新数据
                    const updates = {
                        categoryId,
                        categoryName: category.name,
                        name,
                        budget: parseFloat(budget),
                        price: price ? parseFloat(price) : 0,
                        status,
                        notes,
                        tags,
                        pddLink,
                        image: imageData
                    };
                    
                    console.log('准备更新的商品数据:', updates);
                    
                    // 更新商品
                    this.items[itemIndex] = { ...this.items[itemIndex], ...updates };
                    console.log('商品数据已更新到内存');
                    
                    // 保存到localStorage
                    this.saveData();
                    console.log('商品数据已保存到localStorage');
                    
                    // 更新界面
                    this.renderItems();
                    this.updateStats();
                    this.renderChart();
                    this.renderFloorPlanMarkers();
                    console.log('界面已更新');
                    
                    // 重置文件输入
                    const imageInput = document.getElementById('edit-item-image');
                    if (imageInput) {
                        imageInput.value = '';
                    }
                    
                    // 关闭模态框 - 增强版本
                    console.log('开始关闭编辑模态框...');
                    
                    // 方法1：使用classList添加hidden类（标准方式）
                    const editModal = document.getElementById('edit-item-modal');
                    
                    if (editModal) {
                        console.log('找到编辑模态框元素');
                        
                        // 强制隐藏模态框
                        try {
                            // 移除所有可能的显示类
                            editModal.classList.remove('flex', 'block', 'visible');
                            editModal.classList.add('hidden', 'invisible');
                            
                            // 设置样式强制隐藏
                            editModal.style.display = 'none';
                            editModal.style.visibility = 'hidden';
                            editModal.style.opacity = '0';
                            editModal.style.position = 'fixed';
                            editModal.style.zIndex = '-1';
                            
                            // 标记为隐藏状态
                            editModal.setAttribute('data-visible', 'false');
                            editModal.setAttribute('aria-hidden', 'true');
                            
                            console.log('编辑模态框已通过多种方式强制隐藏');
                            
                            // 验证隐藏状态
                            setTimeout(() => {
                                const computedStyle = window.getComputedStyle(editModal);
                                console.log('模态框隐藏后验证:');
                                console.log('- display:', computedStyle.display);
                                console.log('- visibility:', computedStyle.visibility);
                                console.log('- opacity:', computedStyle.opacity);
                                console.log('- has hidden class:', editModal.classList.contains('hidden'));
                            }, 100);
                            
                        } catch (hideError) {
                            console.error('强制隐藏模态框时发生错误:', hideError);
                        }
                    } else {
                        console.warn('未找到编辑模态框元素，可能已经被隐藏');
                        
                        // 尝试查找所有可能的模态框元素
                        const allModals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
                        console.log('页面上的模态框元素数量:', allModals.length);
                        
                        allModals.forEach((modal, index) => {
                            if (modal.id.includes('edit') || modal.querySelector('#edit-item-form')) {
                                console.log(`找到编辑相关模态框[${index}]，强制隐藏`);
                                modal.style.display = 'none';
                                modal.style.visibility = 'hidden';
                            }
                        });
                    }
                    
                    // 方法2：触发关闭按钮的点击事件（模拟用户操作）
                    const closeButtons = document.querySelectorAll('#edit-item-modal .close-modal');
                    if (closeButtons.length > 0) {
                        console.log('找到关闭按钮，触发点击事件');
                        closeButtons[0].click();
                    }
                    
                    // 方法3：检查并关闭所有可能的模态框容器
                    const modalContainers = document.querySelectorAll('#edit-item-modal, .modal, .modal-dialog');
                    modalContainers.forEach((container, index) => {
                        if (container !== editModal) { // 避免重复操作
                            console.log(`隐藏额外的模态框容器[${index}]:`, container.id || container.className);
                            container.style.display = 'none';
                            container.style.visibility = 'hidden';
                        }
                    });
                    
                    console.log('编辑模态框关闭操作完成');
                    
                    // 显示成功提示
                    this.showSimpleNotification('商品保存成功');
                    
                } catch (error) {
                    console.error('保存商品时发生错误:', error);
                    alert('保存失败：' + error.message);
                }
            }
            
            // 显示商品详情
            showItemDetails(item) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 transform transition-all">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">商品详情</h3>
                            <button class="close-modal text-gray-400 hover:text-gray-600">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="text-center mb-4">
                                <div class="w-20 h-20 bg-gray-100 rounded-lg mx-auto flex items-center justify-center">
                                    <i class="fa fa-shopping-bag text-4xl text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                                <p class="text-gray-800">${item.name}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">所属分类</label>
                                <p class="text-gray-800">${this.categories.find(cat => cat.id === item.categoryId)?.name || '未分类'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">预算金额</label>
                                <p class="text-gray-800">¥${item.budget}</p>
                            </div>
                            ${item.price ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">实际价格</label>
                                    <p class="text-gray-800">¥${item.price}</p>
                                </div>
                            ` : ''}
                            ${item.pddLink ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">商品链接</label>
                                    <div class="mt-1">
                                        <a href="${item.pddLink}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline inline-flex items-center">
                                            <i class="fa fa-external-link mr-1"></i>
                                            <span>${this.getPlatformName(item.pddLink)}</span>
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                            ${item.tags && item.tags.length > 0 ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.tags.map(tagId => {
                                            const tag = this.tags.find(t => t.id === tagId);
                                            return tag ? `<span class="badge" style="background-color: ${tag.color || '#e5e7eb'}">${tag.name}</span>` : '';
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex justify-end pt-4">
                                <button class="btn btn-primary close-modal">关闭</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 添加关闭事件
                modal.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });

                // 防止点击模态框内容区域关闭模态框
                modal.querySelector('.bg-white').addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // 关闭图表视图
            closeChartView() {
                console.log('关闭图表视图');
                
                try {
                    const chartView = document.getElementById('chart-view');
                    const itemsView = document.getElementById('items-view');
                    const chartToggleBtn = document.getElementById('chart-toggle-btn');
                    
                    if (chartView && itemsView && chartToggleBtn) {
                        // 隐藏图表视图
                        chartView.classList.add('hidden');
                        chartView.classList.remove('flex');
                        
                        // 显示商品列表
                        itemsView.classList.remove('hidden');
                        
                        // 更新按钮文本
                        chartToggleBtn.innerHTML = '<i class="fa fa-chart-pie"></i><span>图表视图</span>';
                        
                        // 恢复背景滚动
                        document.body.style.overflow = '';
                        
                        console.log('图表视图已成功关闭');
                    }
                } catch (error) {
                    console.error('关闭图表视图时发生错误:', error);
                }
            }
            
            // 显示预算分析
            showBudgetAnalysis() {
                console.log('显示预算分析');
                
                try {
                    // 显示图表视图模态框
                    const chartView = document.getElementById('chart-view');
                    const itemsView = document.getElementById('items-view');
                    const chartToggleBtn = document.getElementById('chart-toggle-btn');
                    
                    if (chartView && itemsView && chartToggleBtn) {
                        console.log('显示图表视图');
                        
                        // 切换到图表视图
                        chartView.classList.remove('hidden');
                        chartView.classList.add('flex');
                        itemsView.classList.add('hidden');
                        
                        // 更新按钮文本
                        chartToggleBtn.innerHTML = '<i class="fa fa-th-large"></i><span>列表视图</span>';
                        
                        // 重新渲染图表
                        this.renderChart();
                        
                        // 禁用背景滚动
                        document.body.style.overflow = 'hidden';
                        
                        console.log('预算分析显示完成');
                    } else {
                        console.error('找不到必要的元素');
                        alert('预算分析功能暂不可用，请刷新页面重试');
                    }
                    
                } catch (error) {
                    console.error('显示预算分析时发生错误:', error);
                    alert('打开预算分析失败: ' + error.message);
                }
            }
            
            // 添加分类
            addCategory(name, budget) {
                const category = {
                    id: this.generateId(),
                    name,
                    budget: parseFloat(budget),
                    createdAt: new Date().toISOString()
                };
                
                this.categories.push(category);
                this.saveData();
                this.renderCategories();
            }
            
            // 添加商品
            addItem(categoryId, name, budget, price = 0, status = 'pending', notes = '', tagIds = [], pddLink = '', image = null) {
                const category = this.categories.find(cat => cat.id === categoryId);
                if (!category) return null;
                
                // 获取标签详情
                const tags = tagIds.map(tagId => {
                    const tag = this.tags.find(t => t.id === tagId);
                    return tag ? { id: tag.id, name: tag.name, color: tag.color } : null;
                }).filter(tag => tag !== null);
                
                const item = {
                    id: this.generateId(),
                    categoryId,
                    categoryName: category.name,
                    name,
                    budget: parseFloat(budget),
                    price: parseFloat(price) || 0,
                    status,
                    notes,
                    tags,
                    pddLink,
                    image,
                    createdAt: new Date().toISOString()
                };
                
                this.items.push(item);
                this.saveData();
                this.renderItems();
                this.updateStats();
                this.renderChart();
                
                return item;
            }
            
            // 更新商品
            updateItem(id, updates) {
                const index = this.items.findIndex(item => item.id === id);
                if (index !== -1) {
                    // 如果更新了分类，需要更新分类名称
                    if (updates.categoryId) {
                        const category = this.categories.find(cat => cat.id === updates.categoryId);
                        if (category) {
                            updates.categoryName = category.name;
                        }
                    }
                    
                    // 如果更新了标签，需要获取标签详情
                    if (updates.tagIds) {
                        const tags = updates.tagIds.map(tagId => {
                            const tag = this.tags.find(t => t.id === tagId);
                            return tag ? { id: tag.id, name: tag.name, color: tag.color } : null;
                        }).filter(tag => tag !== null);
                        updates.tags = tags;
                        delete updates.tagIds;
                    }
                    
                    this.items[index] = { ...this.items[index], ...updates };
                    this.saveData();
                    this.renderItems();
                    this.updateStats();
                    this.renderChart();
                    this.renderFloorPlanMarkers();
                }
            }
            
            // 删除商品
            deleteItem(id) {
                // 过滤掉要删除的商品
                this.items = this.items.filter(item => item.id !== id);
                
                // 同时删除相关的户型图标记
                this.floorPlan.markers = this.floorPlan.markers.filter(marker => marker.itemId !== id);
                
                // 保存数据并更新界面
                this.saveData();
                this.renderItems();
                this.updateStats();
                this.renderChart();
                this.renderFloorPlanMarkers();
            }
            
            // 添加标签
            addTag(name, color = '#3b82f6') {
                const tag = {
                    id: this.generateId(),
                    name,
                    color
                };
                
                this.tags.push(tag);
                this.saveData();
                this.renderTags();
            }
            
            // 添加户型图标记
            addFloorPlanMarker(x, y, itemId) {
                try {
                    // 检查该商品是否已有标记
                    const existingMarkerIndex = this.floorPlan.markers.findIndex(marker => marker.itemId === itemId);
                    
                    if (existingMarkerIndex !== -1) {
                        // 直接替换现有标记，无需用户确认
                        this.floorPlan.markers[existingMarkerIndex] = {
                            id: this.generateId(),
                            x,
                            y,
                            itemId
                        };
                        
                        // 添加简单的视觉反馈
                        this.showSimpleNotification('标记位置已更新');
                    } else {
                        // 添加新标记
                        const marker = {
                            id: this.generateId(),
                            x,
                            y,
                            itemId
                        };
                        
                        this.floorPlan.markers.push(marker);
                    }
                    
                    // 保存数据并重新渲染
                    this.saveData();
                    
                    this.renderFloorPlanMarkers();
                    
                    // 更新商品列表显示
                    this.renderItems();
                    
                    return true;
                    
                } catch (error) {
                    console.error('添加标记时发生错误:', error);
                    this.showSimpleNotification('添加标记失败', 'error');
                    return false;
                }
            }
            
            // 简单的通知函数（替代弹窗）
            showSimpleNotification(message, type = 'success') {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
                
                // 根据类型设置样式
                switch (type) {
                    case 'success':
                        notification.style.backgroundColor = '#10b981';
                        notification.style.color = 'white';
                        break;
                    case 'error':
                        notification.style.backgroundColor = '#ef4444';
                        notification.style.color = 'white';
                        break;
                    case 'warning':
                        notification.style.backgroundColor = '#f59e0b';
                        notification.style.color = 'white';
                        break;
                    default:
                        notification.style.backgroundColor = '#3b82f6';
                        notification.style.color = 'white';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // 显示动画
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // 自动隐藏
                setTimeout(() => {
                    notification.style.transform = 'translateX(full)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 2000);
            }
            
            // 显示标记提示框
            showMarkerTooltip(marker, item) {
                console.log('显示标记提示框:', item.name);
                
                // 移除现有的提示框
                this.hideMarkerTooltip();
                
                // 创建提示框
                this.markerTooltip = document.createElement('div');
                this.markerTooltip.className = 'marker-tooltip absolute z-50 bg-white shadow-lg rounded-lg p-3 border border-gray-200';
                this.markerTooltip.style.cssText = `
                    position: absolute !important;
                    background: white !important;
                    border: 1px solid #e5e7eb !important;
                    border-radius: 0.5rem !important;
                    padding: 0.75rem !important;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
                    z-index: 10000 !important;
                    max-width: 250px !important;
                    pointer-events: none !important;
                    font-size: 0.875rem !important;
                    color: #1f2937 !important;
                    transition: all 0.2s ease !important;
                `;
                
                this.markerTooltip.innerHTML = `
                    <div class="font-medium text-gray-900 mb-1">${item.name}</div>
                    <div class="text-sm text-gray-600 mb-1">${item.categoryName || '未分类'}</div>
                    <div class="text-sm text-primary font-semibold">¥${(item.price || item.budget).toFixed(2)}</div>
                    <div class="mt-2 text-xs text-gray-500">点击查看详情</div>
                `;
                
                document.body.appendChild(this.markerTooltip);
                this.updateTooltipPosition(marker);
                
                // 监听鼠标移动更新位置
                this.tooltipUpdateHandler = (e) => {
                    this.updateTooltipPosition(marker);
                };
                
                marker.addEventListener('mousemove', this.tooltipUpdateHandler);
            }
            
            // 更新提示框位置
            updateTooltipPosition(marker) {
                if (!this.markerTooltip || !marker) return;
                
                const markerRect = marker.getBoundingClientRect();
                const tooltipRect = this.markerTooltip.getBoundingClientRect();
                
                let left = markerRect.left + markerRect.width / 2 - tooltipRect.width / 2;
                let top = markerRect.top - tooltipRect.height - 10;
                
                // 确保提示框在视窗内
                if (left < 10) left = 10;
                if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }
                if (top < 10) {
                    top = markerRect.bottom + 10;
                }
                
                this.markerTooltip.style.left = left + 'px';
                this.markerTooltip.style.top = top + 'px';
            }
            
            // 隐藏标记提示框
            hideMarkerTooltip() {
                if (this.markerTooltip) {
                    if (this.markerTooltip.parentNode) {
                        this.markerTooltip.parentNode.removeChild(this.markerTooltip);
                    }
                    this.markerTooltip = null;
                }
                
                // 移除鼠标移动事件监听器
                if (this.tooltipUpdateHandler) {
                    const markers = document.querySelectorAll('.floor-plan-marker');
                    markers.forEach(marker => {
                        marker.removeEventListener('mousemove', this.tooltipUpdateHandler);
                    });
                    this.tooltipUpdateHandler = null;
                }
            }
            
            // 显示商品详细信息模态框
            showItemDetailModal(item, marker) {
                console.log('显示商品详情模态框:', item.name, '标记:', marker.id);
                
                // 隐藏现有的提示框
                this.hideMarkerTooltip();
                
                // 移除现有的模态框
                this.hideItemDetailModal();
                
                // 创建模态框容器
                this.detailModal = document.createElement('div');
                this.detailModal.className = 'item-detail-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                this.detailModal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: rgba(0, 0, 0, 0.5) !important;
                    z-index: 10000 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    padding: 1rem !important;
                    animation: fadeIn 0.2s ease !important;
                `;
                
                // 创建模态框内容
                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all';
                modalContent.style.cssText = `
                    background: white !important;
                    border-radius: 0.75rem !important;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
                    width: 100% !important;
                    max-width: 32rem !important;
                    padding: 1.5rem !important;
                    animation: slideIn 0.3s ease !important;
                    max-height: 90vh !important;
                    overflow-y: auto !important;
                `;
                
                // 获取分类信息
                const category = this.categories.find(cat => cat.id === item.categoryId);
                const categoryName = category ? category.name : '未分类';
                
                // 获取标签信息
                const itemTags = item.tags ? item.tags.map(tagId => {
                    const tag = this.tags.find(t => t.id === tagId);
                    return tag ? tag.name : '';
                }).filter(Boolean) : [];
                
                // 模态框内容HTML
                modalContent.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${item.name}</h3>
                            <p class="text-sm text-gray-600">${categoryName}</p>
                        </div>
                        <button type="button" class="close-modal text-gray-400 hover:text-gray-600 transition-colors" style="font-size: 1.5rem; line-height: 1; padding: 0.25rem;">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600 text-sm">预算金额</span>
                                <span class="text-xl font-bold text-primary">¥${(item.budget || 0).toFixed(2)}</span>
                            </div>
                            ${item.price !== undefined ? `
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-600 text-sm">实际价格</span>
                                    <span class="text-lg font-semibold ${item.price <= item.budget ? 'text-green-600' : 'text-red-600'}">
                                        ¥${item.price.toFixed(2)}
                                        ${item.price < item.budget ? '<i class="fa fa-check-circle ml-1"></i>' : ''}
                                        ${item.price > item.budget ? '<i class="fa fa-exclamation-circle ml-1"></i>' : ''}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 text-sm">预算差额</span>
                                    <span class="font-medium ${(item.price || 0) <= item.budget ? 'text-green-600' : 'text-red-600'}">
                                        ${(item.price || 0) <= item.budget ? '+' : '-'}¥${Math.abs((item.price || 0) - item.budget).toFixed(2)}
                                    </span>
                                </div>
                            ` : '<p class="text-sm text-gray-500 italic">暂无实际价格信息</p>'}
                        </div>
                        
                        ${item.description ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">商品描述</h4>
                                <p class="text-sm text-gray-600 whitespace-pre-wrap">${item.description}</p>
                            </div>
                        ` : ''}
                        
                        ${itemTags.length > 0 ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">标签</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${itemTags.map(tag => `
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${tag}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">放置位置</h4>
                            <p class="text-sm text-gray-600">户型图坐标: X: ${marker.x.toFixed(1)}%, Y: ${marker.y.toFixed(1)}%</p>
                        </div>
                        
                        ${item.notes ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">备注</h4>
                                <p class="text-sm text-gray-600 whitespace-pre-wrap">${item.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-6 flex flex-wrap gap-3">

                        <button type="button" class="edit-item px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                            <i class="fa fa-edit mr-2"></i> 编辑商品
                        </button>
                        <button type="button" class="delete-marker px-4 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors flex items-center">
                            <i class="fa fa-trash mr-2"></i> 移除标记
                        </button>
                    </div>
                `;
                
                // 添加CSS动画
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { 
                            opacity: 0; 
                            transform: translateY(-20px) scale(0.95); 
                        }
                        to { 
                            opacity: 1; 
                            transform: translateY(0) scale(1); 
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // 组装模态框
                this.detailModal.appendChild(modalContent);
                document.body.appendChild(this.detailModal);
                
                // 绑定事件监听器
                this.bindDetailModalEvents(item, marker);
            }
            
            // 绑定详情模态框事件
            bindDetailModalEvents(item, marker) {
                if (!this.detailModal) return;
                
                // 关闭模态框
                const closeButtons = this.detailModal.querySelectorAll('.close-modal');
                closeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.hideItemDetailModal();
                    });
                });
                
                // 点击背景关闭
                this.detailModal.addEventListener('click', (e) => {
                    if (e.target === this.detailModal) {
                        this.hideItemDetailModal();
                    }
                });
                
                
                // 编辑商品
                const editButton = this.detailModal.querySelector('.edit-item');
                if (editButton) {
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.hideItemDetailModal();
                        setTimeout(() => {
                            console.log('编辑商品按钮被点击，商品ID:', item.id);
                            this.showEditItemModal(item);
                        }, 300);
                    });
                }
                
                // 删除标记
                const deleteButton = this.detailModal.querySelector('.delete-marker');
                if (deleteButton) {
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.hideItemDetailModal();
                        console.log('删除标记按钮被点击，标记ID:', marker.id);
                        // 直接删除标记，不使用setTimeout
                        this.deleteFloorPlanMarker(marker.id);
                    });
                }
                
                // ESC键关闭
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.hideItemDetailModal();
                    }
                };
                document.addEventListener('keydown', escHandler);
                this.detailModal._escHandler = escHandler;
            }
            
            // 滚动到商品卡片
            scrollToItemCard(itemId) {
                console.log('滚动到商品卡片，商品ID:', itemId);
                
                // 切换到商品管理标签页
                const itemsTab = document.getElementById('items-tab');
                if (itemsTab) {
                    itemsTab.click();
                }
                
                // 等待标签页切换完成
                setTimeout(() => {
                    // 查找商品卡片
                    const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
                    if (itemCard) {
                        console.log('找到商品卡片:', itemCard);
                        
                        // 滚动到商品卡片
                        itemCard.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        
                        // 高亮显示商品卡片
                        itemCard.classList.add('ring-4', 'ring-primary', 'ring-opacity-50');
                        
                        // 3秒后移除高亮
                        setTimeout(() => {
                            itemCard.classList.remove('ring-4', 'ring-primary', 'ring-opacity-50');
                        }, 3000);
                        
                        // 显示成功提示
                        this.showSimpleNotification('已定位到商品', 'success');
                    } else {
                        console.warn('未找到商品卡片，商品ID:', itemId);
                        this.showSimpleNotification('未找到商品卡片', 'warning');
                    }
                }, 300);
            }
            
            // 隐藏商品详细信息模态框
            hideItemDetailModal() {
                if (this.detailModal) {
                    // 移除ESC键监听器
                    if (this.detailModal._escHandler) {
                        document.removeEventListener('keydown', this.detailModal._escHandler);
                    }
                    
                    // 添加淡出动画
                    this.detailModal.style.animation = 'fadeOut 0.2s ease';
                    
                    setTimeout(() => {
                        if (this.detailModal.parentNode) {
                            this.detailModal.parentNode.removeChild(this.detailModal);
                        }
                        this.detailModal = null;
                    }, 200);
                }
            }
            
            // 绑定模态框关闭事件
            bindModalCloseEvents(modal) {
                console.log('绑定模态框关闭事件');
                
                // 移除现有的事件监听器（防止重复绑定）
                const newModal = modal.cloneNode(true);
                modal.parentNode.replaceChild(newModal, modal);
                
                // 绑定关闭按钮
                const closeButtons = newModal.querySelectorAll('.close-modal, .btn-close, .cancel-btn');
                closeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log('关闭按钮被点击');
                        this.closeModal(newModal);
                    });
                });
                
                // 绑定背景点击关闭
                newModal.addEventListener('click', (e) => {
                    if (e.target === newModal) {
                        console.log('背景被点击，关闭模态框');
                        this.closeModal(newModal);
                    }
                });
                
                // 绑定ESC键关闭
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        console.log('ESC键被按下，关闭模态框');
                        this.closeModal(newModal);
                    }
                };
                
                // 移除之前的ESC监听器
                document.removeEventListener('keydown', this.currentEscHandler);
                document.addEventListener('keydown', escHandler);
                this.currentEscHandler = escHandler;
                
                // 绑定保存按钮
                const saveButtons = newModal.querySelectorAll('.save-btn, .btn-save, .submit-btn');
                saveButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // 触发表单提交
                        const form = newModal.querySelector('form');
                        if (form) {
                            form.dispatchEvent(new Event('submit', { cancelable: true }));
                        }
                    });
                });
            }
            
            // 关闭模态框
            closeModal(modal) {
                // 添加淡出动画
                modal.style.animation = 'fadeOut 0.2s ease';
                
                setTimeout(() => {
                    // 隐藏模态框
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // 移除ESC键监听器
                    if (this.currentEscHandler) {
                        document.removeEventListener('keydown', this.currentEscHandler);
                        this.currentEscHandler = null;
                    }
                }, 200);
            }
            
            // 删除户型图标记
            deleteFloorPlanMarker(markerId) {
                console.log('=== 开始删除标记流程 ===');
                console.log('标记ID:', markerId);
                
                // 1. 找到要删除的标记和对应的商品
                const markerIndex = this.floorPlan.markers.findIndex(marker => marker.id === markerId);
                if (markerIndex === -1) {
                    console.log('错误: 未找到要删除的标记');
                    return;
                }
                
                const markerToDelete = this.floorPlan.markers[markerIndex];
                const itemId = markerToDelete.itemId;
                const item = this.items.find(i => i.id === itemId);
                
                if (!item) {
                    console.log('错误: 未找到对应的商品');
                    return;
                }
                
                console.log('要删除的标记:', markerToDelete);
                console.log('对应的商品ID:', itemId);
                console.log('对应的商品:', item.name);
                
                // 2. 从数据中删除标记
                this.floorPlan.markers.splice(markerIndex, 1);
                console.log('删除后标记数量:', this.floorPlan.markers.length);
                
                // 3. 立即保存数据
                this.saveData();
                console.log('数据已保存到localStorage');
                
                // 4. 清除户型图上的标记
                console.log('=== 清除户型图标记 ===');
                const floorPlanMarkers = document.querySelectorAll('.floor-plan-marker');
                floorPlanMarkers.forEach(marker => {
                    if (marker.dataset.markerId === markerId) {
                        marker.remove();
                        console.log('移除了户型图上的标记DOM元素');
                    }
                });
                
                // 5. 直接更新商品卡片上的标记状态
                console.log('=== 直接更新商品卡片标记状态 ===');
                this.updateItemMarkerBadge(itemId);
                
                // 6. 显示成功消息
                this.showSimpleNotification('标记已移除', 'success');
                
                // 7. 立即刷新户型图商品列表显示
                this.renderFloorPlanItems();
                console.log('户型图商品列表已重新渲染');
                
                console.log('=== 删除标记流程完成 ===');
            }
            
            // 直接更新商品卡片上的标记徽章
            updateItemMarkerBadge(itemId) {
                console.log('更新商品卡片标记徽章 - 商品ID:', itemId);
                
                // 查找所有商品卡片
                const itemCards = document.querySelectorAll('#items-list .card');
                console.log('找到商品卡片数量:', itemCards.length);
                
                itemCards.forEach(card => {
                    // 查找卡片中的编辑按钮，获取商品ID
                    const editBtn = card.querySelector('.edit-item-btn');
                    if (editBtn && editBtn.dataset.id === itemId) {
                        console.log('找到对应的商品卡片');
                        
                        // 查找标记徽章
                        const markerBadge = card.querySelector('.marker-badge');
                        if (markerBadge) {
                            console.log('找到标记徽章，更新为灰色');
                            
                            // 直接设置为灰色
                            markerBadge.style.backgroundColor = '#9ca3af';
                            markerBadge.title = '未在户型图上标记';
                            
                            // 添加动画效果
                            markerBadge.style.transition = 'all 0.3s ease';
                            markerBadge.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                markerBadge.style.transform = 'scale(1)';
                            }, 300);
                            
                            console.log('商品卡片标记徽章已更新为灰色');
                        } else {
                            console.log('未找到标记徽章');
                        }
                    }
                });
            }
            

            
            // 清空所有户型图标记
            clearAllFloorPlanMarkers() {
                this.floorPlan.markers = [];
                this.saveData();
                this.renderFloorPlanMarkers();
            }
            
            // 获取指定位置的标记
            getMarkerAtPosition(x, y) {
                return this.floorPlan.markers.find(marker => {
                    const distance = Math.sqrt(Math.pow(marker.x - x, 2) + Math.pow(marker.y - y, 2));
                    return distance < 5; // 5% 的容差
                });
            }
            
            // 滚动到指定商品
            scrollToItem(itemId) {
                const itemCard = document.querySelector(`[data-id="${itemId}"]`);
                if (itemCard) {
                    itemCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    itemCard.classList.add('ring-4', 'ring-primary', 'ring-opacity-50');
                    setTimeout(() => {
                        itemCard.classList.remove('ring-4', 'ring-primary', 'ring-opacity-50');
                    }, 2000);
                }
            }
            
            // 获取平台名称
            getPlatformName(url) {
                if (url.includes('pinduoduo')) return '拼多多';
                if (url.includes('taobao')) return '淘宝';
                if (url.includes('tmall')) return '天猫';
                if (url.includes('jd')) return '京东';
                if (url.includes('suning')) return '苏宁';
                return '商品链接';
            }
            
            // 导出数据
            exportData() {
                const data = {
                    categories: this.categories,
                    items: this.items,
                    tags: this.tags,
                    floorPlan: this.floorPlan,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `furniture-budget-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
            
            // 导入数据
            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.categories && data.items && data.tags) {
                            if (confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                                this.categories = data.categories;
                                this.items = data.items;
                                this.tags = data.tags;
                                this.floorPlan = data.floorPlan || { image: null, markers: [] };
                                
                                this.saveData();
                                this.renderCategories();
                                this.renderTags();
                                this.renderItems();
                                this.updateStats();
                                this.renderChart();
                                
                                alert('数据导入成功！');
                            }
                        } else {
                            alert('导入失败：无效的数据格式');
                        }
                    } catch (error) {
                        alert('导入失败：' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            // 生成唯一ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
            
            // 保存数据到本地存储
            saveData() {
                localStorage.setItem('budgetCategories', JSON.stringify(this.categories));
                localStorage.setItem('budgetItems', JSON.stringify(this.items));
                localStorage.setItem('budgetTags', JSON.stringify(this.tags));
                localStorage.setItem('floorPlan', JSON.stringify(this.floorPlan));
            }
        }
        
        // 全局删除函数
        function deleteItem() {
            console.log('Delete function called');
            
            // 直接从localStorage获取所有商品
            const allItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
            console.log('Total items in storage:', allItems.length);
            
            // 尝试获取编辑模态框中的商品ID
            const idInput = document.getElementById('edit-item-id');
            console.log('ID Input element:', idInput);
            
            if (idInput) {
                const id = idInput.value;
                console.log('Item ID from input:', id);
                
                if (id) {
                    if (confirm('确定要删除这个商品吗？')) {
                        console.log('User confirmed deletion for ID:', id);
                        
                        try {
                            // 删除商品
                            const updatedItems = allItems.filter(item => item.id !== id);
                            console.log('Items after deletion:', updatedItems.length);
                            
                            if (updatedItems.length === allItems.length) {
                                console.warn('No item was deleted. ID might not exist.');
                                alert('未找到要删除的商品，请刷新页面重试');
                                return;
                            }
                            
                            // 删除相关的户型图标记
                            const floorPlan = JSON.parse(localStorage.getItem('floorPlan')) || { markers: [] };
                            const updatedMarkers = floorPlan.markers.filter(marker => marker.itemId !== id);
                            console.log('Markers after cleanup:', updatedMarkers.length);
                            
                            // 保存到localStorage
                            localStorage.setItem('budgetItems', JSON.stringify(updatedItems));
                            floorPlan.markers = updatedMarkers;
                            localStorage.setItem('floorPlan', JSON.stringify(floorPlan));
                            
                            console.log('Data saved successfully');
                            
                            // 关闭模态框
                            const modal = document.getElementById('edit-item-modal');
                            if (modal) {
                                modal.classList.add('hidden');
                            }
                            
                            // 立即重新加载页面以更新UI
                            alert('商品删除成功！');
                            window.location.reload();
                            
                        } catch (error) {
                            console.error('Error during deletion:', error);
                            alert('删除商品时出错：' + error.message);
                        }
                    } else {
                        console.log('Deletion cancelled by user');
                    }
                } else {
                    console.error('No item ID found in input');
                    alert('无法获取商品ID，请刷新页面重试');
                }
            } else {
                console.error('edit-item-id input element not found');
                alert('无法找到商品ID输入框，请刷新页面重试');
            }
        }



        // 执行删除操作的函数
        function performDelete() {
            console.log('=== Delete function called ===');
            
            try {
                // 获取商品ID
                const idInput = document.getElementById('edit-item-id');
                console.log('ID Input element found:', !!idInput);
                
                if (!idInput) {
                    console.error('❌ edit-item-id input not found');
                    alert('无法找到商品信息，请刷新页面重试');
                    return;
                }
                
                const productId = idInput.value;
                console.log('📦 Product ID to delete:', productId);
                
                if (!productId) {
                    console.error('❌ No product ID found in input');
                    alert('无法获取商品ID，请刷新页面重试');
                    return;
                }
                
                // 显示确认对话框
                if (confirm('确定要删除这个商品吗？此操作不可恢复。')) {
                    console.log('✅ User confirmed deletion');
                    
                    // 从localStorage获取所有商品
                    const items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                    console.log('📊 Items before deletion:', items.length);
                    
                    // 查找要删除的商品
                    const itemToDelete = items.find(item => item.id === productId);
                    console.log('🔍 Item found:', !!itemToDelete);
                    
                    if (!itemToDelete) {
                        console.error('❌ Item not found in storage');
                        alert('未找到要删除的商品，请刷新页面重试');
                        return;
                    }
                    
                    // 删除商品
                    const filteredItems = items.filter(item => item.id !== productId);
                    console.log('📊 Items after deletion:', filteredItems.length);
                    
                    if (filteredItems.length === items.length) {
                        console.error('❌ No item was actually deleted');
                        alert('删除失败，请刷新页面重试');
                        return;
                    }
                    
                    // 保存更新后的数据
                    localStorage.setItem('budgetItems', JSON.stringify(filteredItems));
                    console.log('💾 Items saved to localStorage successfully');
                    
                    // 同时删除相关的户型图标记
                    const floorPlan = JSON.parse(localStorage.getItem('floorPlan')) || { markers: [] };
                    const markersBefore = floorPlan.markers.length;
                    const updatedMarkers = floorPlan.markers.filter(marker => marker.itemId !== productId);
                    const markersAfter = updatedMarkers.length;
                    console.log(`📍 Floor plan markers: ${markersBefore} → ${markersAfter}`);
                    
                    if (markersBefore !== markersAfter) {
                        floorPlan.markers = updatedMarkers;
                        localStorage.setItem('floorPlan', JSON.stringify(floorPlan));
                        console.log('💾 Floor plan updated successfully');
                    }
                    
                    // 关闭模态框
                    const modal = document.getElementById('edit-item-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                        console.log('🚪 Modal closed');
                    }
                    
                    // 显示成功消息
                    alert('商品已成功删除！');
                    console.log('✅ Deletion process completed successfully');
                    
                    // 立即刷新页面
                    console.log('🔄 Reloading page...');
                    window.location.reload();
                    
                } else {
                    console.log('❌ Deletion cancelled by user');
                }
                
            } catch (error) {
                console.error('💥 Error during deletion process:', error);
                alert('删除商品时出错：' + error.message);
            }
            
            console.log('=== Delete function ended ===');
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const budgetManager = new BudgetManager();
            window.budgetManager = budgetManager; // 方便调试
            
            // 添加删除按钮事件监听器
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    console.log('=== Delete button clicked ===');
                    
                    // 获取商品ID
                    const idInput = document.getElementById('edit-item-id');
                    if (!idInput) {
                        console.error('❌ edit-item-id input not found');
                        alert('无法找到商品信息，请刷新页面重试');
                        return;
                    }
                    
                    const productId = idInput.value;
                    console.log('📦 Product ID to delete:', productId);
                    
                    if (!productId) {
                        console.error('❌ No product ID found in input');
                        alert('无法获取商品ID，请刷新页面重试');
                        return;
                    }
                    
                    // 显示确认对话框
                    if (confirm('确定要删除这个商品吗？此操作不可恢复。')) {
                        console.log('✅ User confirmed deletion');
                        
                        try {
                            // 从localStorage获取所有商品
                            const items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                            console.log('📊 Items before deletion:', items.length);
                            
                            // 查找要删除的商品
                            const itemToDelete = items.find(item => item.id === productId);
                            console.log('🔍 Item found:', !!itemToDelete);
                            
                            if (!itemToDelete) {
                                console.error('❌ Item not found in storage');
                                alert('未找到要删除的商品，请刷新页面重试');
                                return;
                            }
                            
                            // 删除商品
                            const filteredItems = items.filter(item => item.id !== productId);
                            console.log('📊 Items after deletion:', filteredItems.length);
                            
                            if (filteredItems.length === items.length) {
                                console.error('❌ No item was actually deleted');
                                alert('删除失败，请刷新页面重试');
                                return;
                            }
                            
                            // 保存更新后的数据
                            localStorage.setItem('budgetItems', JSON.stringify(filteredItems));
                            console.log('💾 Items saved to localStorage successfully');
                            
                            // 同时删除相关的户型图标记
                            const floorPlan = JSON.parse(localStorage.getItem('floorPlan')) || { markers: [] };
                            const markersBefore = floorPlan.markers.length;
                            const updatedMarkers = floorPlan.markers.filter(marker => marker.itemId !== productId);
                            const markersAfter = updatedMarkers.length;
                            console.log(`📍 Floor plan markers: ${markersBefore} → ${markersAfter}`);
                            
                            if (markersBefore !== markersAfter) {
                                floorPlan.markers = updatedMarkers;
                                localStorage.setItem('floorPlan', JSON.stringify(floorPlan));
                                console.log('💾 Floor plan updated successfully');
                            }
                            
                            // 关闭模态框
                            const modal = document.getElementById('edit-item-modal');
                            if (modal) {
                                modal.classList.add('hidden');
                                console.log('🚪 Modal closed');
                            }
                            
                            // 显示成功消息
                            alert('商品已成功删除！');
                            console.log('✅ Deletion process completed successfully');
                            
                            // 立即刷新页面
                            console.log('🔄 Reloading page...');
                            window.location.reload();
                            
                        } catch (error) {
                            console.error('💥 Error during deletion process:', error);
                            alert('删除商品时出错：' + error.message);
                        }
                    } else {
                        console.log('❌ Deletion cancelled by user');
                    }
                }
            });
        });
    </script>
</body>
</html>